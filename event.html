<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¿½æ˜Ÿå­˜éŒ¢ï½œäº‹ä»¶çµ±æ•´</title>
  <link rel="stylesheet" href="assets/app.css" />
  <style>
    .two{display:grid; gap:12px;}
    @media (min-width:900px){ .two{grid-template-columns: .95fr 1.05fr;} }
    .list{display:flex; flex-direction:column; gap:8px;}
    .item{
      border:1px solid var(--line);
      background: rgba(18,26,39,.80);
      border-radius:14px;
      padding:12px;
      cursor:pointer;
      transition:.12s transform ease, .12s opacity ease;
    }
    .item:hover{transform: translateY(-1px); opacity:.96;}
    .item .t{font-weight:900;}
    .item .m{color:var(--muted); font-size:12px; margin-top:4px;}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .tab{
      padding:8px 10px; border:1px solid var(--line);
      border-radius:999px; background:var(--btn);
      cursor:pointer; color:var(--muted);
      font-size:12px; font-weight:900;
    }
    .tab.active{
      color:var(--ink);
      border-color: rgba(125,211,252,.35);
      box-shadow:0 0 0 2px rgba(125,211,252,.1) inset;
    }
  </style>
</head>
<body>
  <div class="bg-wrap"></div>

<header>
  <h1>äº‹ä»¶çµ±æ•´ï¼ˆæ—¥ç³»æ‰‹å¸³é¢¨ï¼‰</h1>
  <p class="sub"><a href="index.html">â† å›é¦–é </a>ã€€ï½œã€€<a href="calendar.html">å»æœˆæ›†è¨˜éŒ„</a></p>
</header>

<main class="two">
  <section class="card">
    <h2 style="margin:0 0 8px; font-size:15px;">äº‹ä»¶åˆ—è¡¨</h2>

    <div class="tabs" id="catTabs"></div>

    <div class="row">
      <div style="flex:1 1 240px;">
        <label>æœå°‹äº‹ä»¶</label>
        <input id="q" type="text" placeholder="ä¾‹å¦‚ï¼šIG / ç›´æ’­ / é›œèªŒ..." />
      </div>
      <div style="flex:1 1 160px;">
        <label>æ’åº</label>
        <select id="sort">
          <option value="money_desc">é‡‘é¡ï¼šé«˜â†’ä½</option>
          <option value="money_asc">é‡‘é¡ï¼šä½â†’é«˜</option>
          <option value="name_asc">åç¨±ï¼šAâ†’Z</option>
          <option value="name_desc">åç¨±ï¼šZâ†’A</option>
        </select>
      </div>
      <div style="flex:0 0 auto; margin-top:28px;">
        <button class="btn" id="refresh">ğŸ”„ é‡æ–°æ•´ç†</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <span class="pill">äº‹ä»¶æ•¸ï¼š<b id="eventCount">0</b></span>
      <span class="pill">ç¸½å­˜å…¥ï¼š<b id="grand">0</b> å…ƒ</span>
      <span class="pill">ç›®å‰åˆ†é¡ï¼š<b id="pickedCat">å…¨éƒ¨</b></span>
    </div>

    <div class="list" id="eventList" style="margin-top:12px;"></div>
    <p class="hint">åˆ†é¡åˆ‡æ›æœƒåŒæ­¥å½±éŸ¿ï¼šäº‹ä»¶åŠ ç¸½ã€æ—¥æœŸåŠ ç¸½ã€ç•¶æ—¥æ˜ç´°ã€‚</p>
  </section>

  <aside class="card">
    <h2 style="margin:0 0 8px; font-size:15px;">è©³ç´°</h2>

    <div class="row" style="margin-top:10px;">
      <span class="pill">ç›®å‰äº‹ä»¶ï¼š<b id="pickedEvent">ï¼ˆå°šæœªé¸ï¼‰</b></span>
      <span class="pill">äº‹ä»¶ç¸½é¡ï¼š<b id="pickedEventSum">0</b> å…ƒ</span>
      <span class="pill">ç›®å‰æ—¥æœŸï¼š<b id="pickedDate">ï¼ˆå°šæœªé¸ï¼‰</b></span>
    </div>

    <div style="margin-top:10px;">
      <h3 style="margin:0 0 8px; font-size:14px;">æ­¤äº‹ä»¶çš„æ¯æ—¥åŠ ç¸½</h3>
      <table>
        <thead><tr><th>æ—¥æœŸ</th><th class="right">é‡‘é¡</th><th class="right">æŸ¥çœ‹</th></tr></thead>
        <tbody id="datesBody"></tbody>
      </table>
    </div>

    <div style="margin-top:10px;">
      <h3 style="margin:0 0 8px; font-size:14px;">è©²æ—¥æ˜ç´°ï¼ˆä¾åˆ†é¡ç¯©é¸ï¼‰</h3>
      <table>
        <thead><tr><th>é¼“å‹µ</th><th>åˆ†é¡</th><th>äº‹ä»¶</th><th class="right">é‡‘é¡</th></tr></thead>
        <tbody id="dayBody"></tbody>
      </table>
    </div>
  </aside>
</main>

<script type="module">
  import {
    loadData, sumByEvent, sumByDateForEvent, filterRecordsByCat,
    applyBackground
  } from "./assets/app.js";

  await applyBackground("planner");

  const el = id => document.getElementById(id);
  let data = loadData();

  let filterCat = ""; // "" => all
  let currentEvent = "";
  let currentDate = "";

  function grandTotalFiltered(){
    let s = 0;
    for(const arr of Object.values(data.records)){
      for(const r of filterRecordsByCat(arr, filterCat)){
        s += (Number(r.amount)||0);
      }
    }
    return s;
  }

  function renderTabs(){
    const tabs = el("catTabs");
    tabs.innerHTML = "";

    const items = [
      {label:"å…¨éƒ¨", value:""},
      {label:"Shokichi", value:"Shokichiï¼ˆå€‹äººï¼‰"},
      {label:"Akira", value:"Akiraï¼ˆå€‹äººï¼‰"},
      {label:"åœ˜é«”", value:"EXILE THE SECONDï¼ˆåœ˜é«”ï¼‰"},
    ];

    for(const t of items){
      const div = document.createElement("div");
      div.className = "tab" + (filterCat === t.value ? " active" : "");
      div.textContent = t.label;
      div.addEventListener("click", ()=>{
        filterCat = t.value;
        el("pickedCat").textContent = t.label;
        renderTabs();
        renderEventList();
        if(currentEvent) pickEvent(currentEvent);
        else { renderDatesForEvent(); renderDayAll(); }
      });
      tabs.appendChild(div);
    }
  }

  function renderEventList(){
    const q = (el("q").value || "").trim().toLowerCase();
    const sort = el("sort").value;

    const map = sumByEvent(data, filterCat);
    let arr = [...map.entries()].map(([event, total])=>({event, total}));

    if(q) arr = arr.filter(x => x.event.toLowerCase().includes(q));

    if(sort === "money_desc") arr.sort((a,b)=>b.total-a.total);
    if(sort === "money_asc") arr.sort((a,b)=>a.total-b.total);
    if(sort === "name_asc") arr.sort((a,b)=>a.event.localeCompare(b.event));
    if(sort === "name_desc") arr.sort((a,b)=>b.event.localeCompare(a.event));

    el("eventCount").textContent = String(arr.length);
    el("grand").textContent = String(grandTotalFiltered());

    const list = el("eventList");
    list.innerHTML = "";
    if(arr.length === 0){
      list.innerHTML = `<div style="color:var(--muted); padding:12px;">æ²’æœ‰ç¬¦åˆçš„äº‹ä»¶ã€‚å…ˆå»æœˆæ›†é è¨˜éŒ„ä¸€ç­†å§ã€‚</div>`;
      return;
    }

    for(const x of arr){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<div class="t">${x.event}</div><div class="m">ç´¯è¨ˆï¼š${x.total} å…ƒï¼ˆé»æˆ‘çœ‹æ—¥æœŸï¼‰</div>`;
      div.addEventListener("click", ()=>pickEvent(x.event));
      list.appendChild(div);
    }
  }

  function pickEvent(eventName){
    currentEvent = eventName;
    el("pickedEvent").textContent = eventName;
    const total = sumByEvent(data, filterCat).get(eventName) || 0;
    el("pickedEventSum").textContent = String(total);

    currentDate = "";
    el("pickedDate").textContent = "ï¼ˆå°šæœªé¸ï¼‰";
    renderDatesForEvent();
    renderDayAll();
  }

  function renderDatesForEvent(){
    const tbody = el("datesBody");
    tbody.innerHTML = "";

    if(!currentEvent){
      tbody.innerHTML = `<tr><td colspan="3" style="color:var(--muted); padding:14px;">å…ˆåœ¨å·¦é‚Šé¸ä¸€å€‹äº‹ä»¶</td></tr>`;
      return;
    }

    const rows = sumByDateForEvent(data, currentEvent, filterCat);
    if(rows.length === 0){
      tbody.innerHTML = `<tr><td colspan="3" style="color:var(--muted); padding:14px;">æ­¤äº‹ä»¶åœ¨ç›®å‰åˆ†é¡æ²’æœ‰ç´€éŒ„</td></tr>`;
      return;
    }

    for(const [date, sum] of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${date}</td><td class="right">${sum}</td><td class="right"><button class="btn">æŸ¥çœ‹</button></td>`;
      tr.querySelector("button").addEventListener("click", ()=>{
        currentDate = date;
        el("pickedDate").textContent = date;
        renderDayAll();
      });
      tbody.appendChild(tr);
    }
  }

  function renderDayAll(){
    const tbody = el("dayBody");
    tbody.innerHTML = "";

    if(!currentDate){
      tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted); padding:14px;">å…ˆé¸ä¸€å€‹æ—¥æœŸ</td></tr>`;
      return;
    }

    const arr = data.records[currentDate] || [];
    const filtered = filterRecordsByCat(arr, filterCat).slice().reverse();

    if(filtered.length === 0){
      tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted); padding:14px;">è©²æ—¥ï¼ˆåœ¨ç›®å‰åˆ†é¡ï¼‰ç„¡ç´€éŒ„</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(x=>`
      <tr>
        <td>${x.rewardImg ? `<img class="thumb" src="${x.rewardImg}" alt="reward">` : ""}</td>
        <td>${x.cat}</td>
        <td>${x.event}${x.times>1?` Ã—${x.times}`:""}</td>
        <td class="right">${x.amount}</td>
      </tr>
    `).join("");
  }

  el("q").addEventListener("input", renderEventList);
  el("sort").addEventListener("change", renderEventList);
  el("refresh").addEventListener("click", async ()=>{
    data = loadData();
    await applyBackground("planner");
    renderEventList();
    if(currentEvent) pickEvent(currentEvent);
    else { renderDatesForEvent(); renderDayAll(); }
  });

  renderTabs();
  el("pickedCat").textContent = "å…¨éƒ¨";
  renderEventList();
  renderDatesForEvent();
  renderDayAll();

  window.addEventListener("focus", async ()=>{
    data = loadData();
    await applyBackground("planner");
    renderEventList();
    if(currentEvent) pickEvent(currentEvent);
  });
</script>
</body>
</html>
