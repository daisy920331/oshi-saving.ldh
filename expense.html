<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>èŠ±è²»æœˆæ›†</title>
  <link rel="stylesheet" href="assets/app.css" />
</head>
<body>
  <div class="bg-wrap"></div>

  <header class="topbar">
    <a class="back" href="index.html">â†</a>
    <div class="title">èŠ±è²»æœˆæ›†</div>
    <a class="gear" href="settings.html">âš™</a>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="cal-header">
        <button class="btn" id="prev">ä¸Šå€‹æœˆ</button>
        <div class="cal-month" id="monthLabel"></div>
        <button class="btn" id="next">ä¸‹å€‹æœˆ</button>
      </div>

      <div id="dow" class="dow-row"></div>
      <div id="grid" class="grid"></div>
    </div>

    <div class="panel-overlay" id="overlay"></div>
    <div class="panel" id="panel">
      <div class="panel-head">
        <div class="panel-title"><span id="pickedDate"></span></div>
        <button class="btn" id="close">âœ•</button>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <span class="pill">æ—¥æœŸï¼š<b id="pickedDate2"></b></span>
        <span class="pill">ä»Šå¤©èŠ±è²»ï¼š<b id="dayTotal">0</b> å…ƒ</span>
      </div>

      <div class="card" style="padding:14px;">
        <h3 style="margin:0 0 8px; font-size:14px;">æ–°å¢ä¸€ç­†èŠ±è²»</h3>

        <label>å°è±¡</label>
        <select id="cat"></select>

        <label>åŸå› é¡å‹</label>
        <select id="reasonSel"></select>

        <div id="reasonOtherWrap" style="display:none;">
          <label>å…¶ä»–åŸå› ï¼ˆè‡ªå¡«ï¼‰</label>
          <input id="reasonOther" type="text" placeholder="ä¾‹ï¼šåœè»Šè²»ã€å¯„é€ã€ä»£è³¼æ‰‹çºŒè²»â€¦" />
        </div>

        <label>å‚™è¨»</label>
        <textarea id="note" rows="3" placeholder="ä¾‹ï¼šè²·äº†å“ªå€‹å‘¨é‚Š/åœ¨å“ªè£¡è²·/èª°ä»£è³¼â€¦"></textarea>

        <label>é‡‘é¡</label>
        <input id="amt" type="number" min="0" value="0" />

        <button class="btn primary" id="add">â• åŠ å…¥ä»Šå¤©</button>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="clearDecos">ğŸ§¹ æ¸…é™¤ä»Šå¤©è£é£¾</button>
          <button class="btn" id="clearDay"><span style="color:#b42318;">æ¸…ç©ºä»Šå¤©èŠ±è²»</span></button>
        </div>
      </div>

      <div class="card" style="padding:14px; margin-top:10px;">
        <h3 style="margin:0 0 8px; font-size:14px;">ä»Šæ—¥æ˜ç´°</h3>
        <table>
          <thead><tr><th>å°è±¡</th><th>åŸå› </th><th>å‚™è¨»</th><th class="right">é‡‘é¡</th></tr></thead>
          <tbody id="log"></tbody>
        </table>
      </div>
    </div>
  </main>

<script type="module">
  import { guardSetup } from "./assets/app.js";
  guardSetup();

  import { getCats, ymd, ymLabel, applyBackground } from "./assets/app.js";
  await applyBackground("planner");

  // ===== storage keys =====
  const EXP_KEY   = "oshi_expenses_v1";        // èŠ±è²»è³‡æ–™
  const ASSET_KEY = "oshi_deco_assets_v1";     // å…±ç”¨è²¼ç´™åº«
  const DECO_KEY  = "oshi_expense_decos_v1";   // èŠ±è²»æœˆæ›†è£é£¾

  // åŸå› é¸é …
  const REASONS = [
    "å‘¨é‚Š/ä»£è³¼",
    "äº¤é€š",
    "é¤é£²",
    "ä½å®¿",
    "æ´»å‹•/ç¥¨å‹™ç›¸é—œ",
    "æœƒå“¡/è¨‚é–±",
    "å…¶ä»–"
  ];

  const el = id => document.getElementById(id);
  const esc = s => String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

  function loadExpenses(){
    const raw = localStorage.getItem(EXP_KEY);
    if(!raw) return { records:{} };
    try{
      const x = JSON.parse(raw);
      return x && x.records ? x : { records:{} };
    }catch{
      return { records:{} };
    }
  }
  function saveExpenses(x){
    localStorage.setItem(EXP_KEY, JSON.stringify(x));
  }

  function loadAssets(){
    try{ return JSON.parse(localStorage.getItem(ASSET_KEY)||"[]") || []; }
    catch{ return []; }
  }
  function saveAssets(arr){
    localStorage.setItem(ASSET_KEY, JSON.stringify(arr));
  }

  function loadDecos(){
    try{ return JSON.parse(localStorage.getItem(DECO_KEY)||"{}") || {}; }
    catch{ return {}; }
  }
  function saveDecos(obj){
    localStorage.setItem(DECO_KEY, JSON.stringify(obj));
  }

  function catClass(cat){
    if((cat||"").includes("Shokichi")) return "cat-shokichi";
    if((cat||"").includes("Akira")) return "cat-akira";
    return "cat-group";
  }

  function daySum(exp, dateKey){
    const arr = exp.records[dateKey] || [];
    return arr.reduce((s,r)=> s + (Number(r.amount)||0), 0);
  }

  function topSpendRecord(exp, dateKey){
    const arr = exp.records[dateKey] || [];
    if(!arr.length) return null;
    return arr.reduce((best, r)=>{
      const a = Number(r.amount)||0;
      return !best || a > (Number(best.amount)||0) ? r : best;
    }, null);
  }

  // ======= âœ… å°è±¡ä¸‹æ‹‰ï¼šå³æ™‚è®€è¨­å®š =======
  function renderCats(){
    const cats = getCats();
    el("cat").innerHTML = cats.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
  }
  window.addEventListener("pageshow", ()=>{ renderCats(); });

  // ===== reason =====
  function syncReasonOther(){
    const isOther = el("reasonSel").value === "å…¶ä»–";
    el("reasonOtherWrap").style.display = isOther ? "block" : "none";
    if(!isOther) el("reasonOther").value = "";
  }

  // ===== view =====
  const today = new Date();
  let viewY = today.getFullYear();
  let viewM = today.getMonth();
  let pickedDate = ymd(today);

  function renderDow(){
    const names = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    el("dow").innerHTML = names.map(n=>`<div class="dow">${n}</div>`).join("");
  }

  // è£é£¾ï¼ˆcell å…§ï¼‰
  function renderDecosInCell(cell, dateKey){
    const decos = loadDecos();
    const list = decos[dateKey] || [];
    cell.querySelectorAll(".deco").forEach(x=>x.remove());

    for(const d of list){
      const div = document.createElement("div");
      div.className = "deco";
      div.style.left = (d.x ?? 10) + "px";
      div.style.top  = (d.y ?? 10) + "px";
      div.style.backgroundImage = `url("${d.src}")`;

      div.addEventListener("dblclick", (e)=>{
        e.preventDefault();
        e.stopPropagation();
        const decos2 = loadDecos();
        const arr = decos2[dateKey] || [];
        const idx = arr.findIndex(x => x.src===d.src && x.x===d.x && x.y===d.y);
        if(idx >= 0){
          arr.splice(idx,1);
          if(arr.length) decos2[dateKey] = arr;
          else delete decos2[dateKey];
          saveDecos(decos2);
          render();
          renderDay();
        }
      });

      cell.appendChild(div);
    }
  }

  function render(){
    const exp = loadExpenses();
    el("monthLabel").textContent = ymLabel(viewY, viewM);

    const first = new Date(viewY, viewM, 1);
    const startDay = first.getDay();
    const daysInMonth = new Date(viewY, viewM+1, 0).getDate();

    const cells = [];
    for(let i=0;i<startDay;i++) cells.push(null);
    for(let d=1; d<=daysInMonth; d++){
      cells.push(new Date(viewY, viewM, d));
    }
    while(cells.length % 7 !== 0) cells.push(null);

    el("grid").innerHTML = "";
    const now = new Date();

    for(const dt of cells){
      const cell = document.createElement("div");
      cell.className = "cell";

      if(!dt){
        cell.classList.add("empty");
        el("grid").appendChild(cell);
        continue;
      }

      const key = ymd(dt);
      if(key === ymd(now)) cell.classList.add("today");

      const sum = daySum(exp, key);
      if(sum > 0) cell.classList.add("has");
      else cell.classList.add("none");

      const num = document.createElement("div");
      num.className = "num";
      num.textContent = String(dt.getDate());
      cell.appendChild(num);

      const top = topSpendRecord(exp, key);
      if(top){
        const tag = document.createElement("div");
        tag.className = `tag ${catClass(top.cat)}`;
        tag.textContent = (top.cat || "");
        cell.appendChild(tag);
      }

      const amt = document.createElement("div");
      amt.className = "amt";
      amt.textContent = sum > 0 ? `-${sum}` : "";
      cell.appendChild(amt);

      renderDecosInCell(cell, key);

      cell.addEventListener("click", ()=>{
        openDay(key);
      });

      el("grid").appendChild(cell);
    }
  }

  function renderDay(){
    const exp = loadExpenses();
    const arr = exp.records[pickedDate] || [];
    el("pickedDate").textContent = pickedDate;
    el("pickedDate2").textContent = pickedDate;

    const total = arr.reduce((s,r)=>s + (Number(r.amount)||0), 0);
    el("dayTotal").textContent = String(total);

    const tbody = el("log");
    tbody.innerHTML = "";

    for(const r of arr){
      const tr = document.createElement("tr");
      tr.className = catClass(r.cat);

      const tdCat = document.createElement("td");
      tdCat.textContent = r.cat || "";
      tr.appendChild(tdCat);

      const tdReason = document.createElement("td");
      tdReason.textContent = r.reason || "";
      tr.appendChild(tdReason);

      const tdNote = document.createElement("td");
      tdNote.textContent = r.note || "";
      tr.appendChild(tdNote);

      const tdAmt = document.createElement("td");
      tdAmt.className = "right";
      tdAmt.textContent = String(Number(r.amount)||0);
      tr.appendChild(tdAmt);

      tbody.appendChild(tr);
    }
  }

  function openDay(dateKey){
    pickedDate = dateKey;
    renderCats(); // æ¯æ¬¡æ‰“é–‹éƒ½åŒæ­¥æœ€æ–°å°è±¡

    // åˆå§‹åŒ–åŸå› é¸å–®ï¼ˆç¬¬ä¸€æ¬¡ï¼‰
    if(!el("reasonSel").options.length){
      el("reasonSel").innerHTML = REASONS.map(r=>`<option value="${esc(r)}">${esc(r)}</option>`).join("");
      el("reasonSel").value = REASONS[0];
      syncReasonOther();
      el("reasonSel").addEventListener("change", syncReasonOther);
    }

    el("overlay").classList.add("show");
    el("panel").classList.add("open");
    renderDay();
  }

  function closeDay(){
    el("overlay").classList.remove("show");
    el("panel").classList.remove("open");
  }

  // ===== actions =====
  el("prev").onclick = ()=>{ viewM--; if(viewM<0){viewM=11; viewY--;} render(); };
  el("next").onclick = ()=>{ viewM++; if(viewM>11){viewM=0; viewY++;} render(); };
  el("close").onclick = closeDay;
  el("overlay").onclick = closeDay;

  el("add").onclick = ()=>{
    const exp = loadExpenses();
    const cat = el("cat").value;

    const reasonSel = el("reasonSel").value;
    const reasonOther = (el("reasonOther").value || "").trim();
    const reason = reasonSel === "å…¶ä»–" ? (reasonOther || "å…¶ä»–") : reasonSel;

    const note = (el("note").value || "").trim();
    const amount = Math.max(0, Number(el("amt").value||0));

    const rec = {
      cat,
      reason,
      note,
      amount,
      ts: Date.now()
    };

    if(!exp.records[pickedDate]) exp.records[pickedDate] = [];
    exp.records[pickedDate].push(rec);
    saveExpenses(exp);

    el("amt").value = "0";
    el("note").value = "";

    render();
    renderDay();
  };

  el("clearDay").onclick = ()=>{
    if(!confirm("è¦æ¸…ç©ºä»Šå¤©æ‰€æœ‰èŠ±è²»ç´€éŒ„å—ï¼Ÿ")) return;
    const exp = loadExpenses();
    delete exp.records[pickedDate];
    saveExpenses(exp);
    render();
    renderDay();
  };

  el("clearDecos").onclick = ()=>{
    const decos = loadDecos();
    delete decos[pickedDate];
    saveDecos(decos);
    render();
    renderDay();
  };

  // init
  renderCats();
  renderDow();
  render();
</script>
</body>
</html>
