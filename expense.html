<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¿½æ˜Ÿæ‰‹å¸³ï½œèŠ±è²»æœˆæ›†</title>
  <link rel="stylesheet" href="assets/app.css" />
  <style>
    .wrap{max-width:980px;margin:0 auto;padding:18px 16px 40px;}
    .calendar{display:grid; grid-template-columns: repeat(7, 1fr); gap:10px;}
    .dow{color:var(--muted); font-size:12px; padding:0 2px 6px;}

    .monthbar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .monthbar .left{justify-self:start}
    .monthbar .center{justify-self:center}
    .monthbar .right{justify-self:end}

    .cell{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.70);
      min-height:120px;
      padding:12px;
      cursor:pointer;
      position:relative;
      transition:.12s transform ease, .12s opacity ease;
      overflow:hidden;
    }
    .cell:hover{transform: translateY(-1px); opacity:.96;}
    .date{font-weight:800; font-size:14px;}
    .sum{margin-top:6px; font-weight:900; font-size:14px;}
    .outside{opacity:.30}

    /* æœ‰èŠ±è²»ï¼šäº® */
    .cell.has-spend{
      background:#ffffff;
      border-color:#e6e2d9;
      box-shadow: 0 12px 24px rgba(0,0,0,.08), 0 2px 0 rgba(0,0,0,.03);
    }
    /* æ²’èŠ±è²»ï¼šæš— */
    .cell.no-spend{
      background: rgba(90,90,90,.16);
      border-color: rgba(90,90,90,.22);
      box-shadow:none;
    }
    .cell.no-spend .sum{color: rgba(20,20,20,.55);}

    /* é¡¯ç¤ºï¼šç•¶æ—¥æœ€å¤§èŠ±è²»é‚£ç­†çš„å°è±¡ï¼ˆä¸Šè‰²æ¨™ç±¤ï¼‰ */
    .topcat{
      margin-top:6px;
      display:inline-flex;
      align-items:center;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid transparent;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      background:#faf9f6;
    }
    .cat-shokichi{background: rgba(226, 88, 34, .14); color:#c2410c; border-color: rgba(226, 88, 34, .35);}
    .cat-akira{background: rgba(32, 32, 32, .08); color:#1f1f1f; border-color: rgba(180,150,90,.55); box-shadow: inset 0 0 0 1px rgba(180,150,90,.25);}
    .cat-group{background: rgba(34, 139, 34, .14); color:#166534; border-color: rgba(34, 139, 34, .35);}

    /* è£é£¾è²¼ç´™ï¼ˆå¯æ‹–æ›³ï¼‰ */
    .deco{
      position:absolute;
      width:34px;height:34px;
      border-radius:10px;
      background-size:cover;
      background-position:center;
      box-shadow:0 10px 18px rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.55);
      cursor:grab;
      z-index:3;
    }

    /* å´é‚Šé¢æ¿ */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; z-index:20;}
    .panel{
      position:fixed; right:0; top:0; height:100%; width:min(480px, 100%);
      background: rgba(255,255,255,.96);
      border-left:1px solid var(--line);
      transform: translateX(100%); transition:.18s transform ease;
      z-index:21; padding:16px; overflow:auto; backdrop-filter: blur(10px);
    }
    .panel.open{transform: translateX(0);}
    .overlay.show{display:block;}
    .x{float:right; font-size:14px; padding:8px 10px; border-radius:999px;}

    table{background:white}
    th{background:#faf9f6}
    .right{text-align:right}

    /* åº•éƒ¨è²¼ç´™å€ */
    .assetBar{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.85);
      padding:12px;
      box-shadow:0 10px 22px rgba(0,0,0,.06), 0 2px 0 rgba(0,0,0,.02);
    }
    .assetRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .assetTray{
      margin-top:10px;
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:4px;
    }
    .assetItem{
      width:52px;height:52px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#faf9f6;
      object-fit:cover;
      flex:0 0 auto;
      cursor:grab;
    }
    .smallHint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div class="bg-wrap"></div>

<header>
  <h1>èŠ±è²»æœˆæ›†</h1>
  <div class="sub"><a href="index.html">â† å›é¦–é </a></div>
</header>

<div class="wrap">
  <div class="monthbar">
    <div class="left"><button class="btn" id="prev">â—€ ä¸Šå€‹æœˆ</button></div>
    <div class="center"><span class="pill">æœˆä»½ï¼š<b id="ym"></b></span></div>
    <div class="right"><button class="btn" id="next">ä¸‹å€‹æœˆ â–¶</button></div>
  </div>

  <div class="row" style="justify-content:space-between;margin-bottom:10px;">
    <span class="pill">æœ¬æœˆèŠ±è²»ï¼š<b id="monthTotal">0</b> å…ƒ</span>
    <span class="pill">æç¤ºï¼šæœ‰èŠ±è²»æ—¥äº®ã€æ²’èŠ±è²»æš—</span>
  </div>

  <div class="calendar" id="dow"></div>
  <div class="calendar" id="cal"></div>

  <!-- è²¼ç´™/å°ç…§ç‰‡å€ï¼šå’Œå­˜éŒ¢æœˆæ›†å…±ç”¨åŒä¸€å€‹ç´ æåº« -->
  <div class="assetBar">
    <div class="assetRow">
      <b>å°è²¼ç´™ / å°ç…§ç‰‡</b>
      <div class="row">
        <input id="assetPicker" type="file" accept="image/*" multiple style="display:none"/>
        <button class="btn" id="addAssets">ï¼‹æ–°å¢è²¼ç´™</button>
        <button class="btn" id="clearAssets"><span style="color:#b42318">æ¸…ç©ºè²¼ç´™åº«</span></button>
      </div>
    </div>
    <div class="smallHint">æ‹–æ›³è²¼ç´™åˆ°æ—¥æœŸæ ¼å­å³å¯è£é£¾ã€‚æ ¼å­å…§è²¼ç´™ï¼šæ‹–æ›³å¯ç§»å‹•ã€é›™æ“Šåˆªé™¤ã€å³éµæ›¿æ›ã€‚</div>
    <div class="assetTray" id="assetTray"></div>
  </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="panel" id="panel">
  <button class="btn x" id="close">âœ•</button>

  <h2 style="margin:0 0 10px; font-size:15px;">æ¯æ—¥èŠ±è²»</h2>

  <div class="row" style="margin-bottom:10px;">
    <span class="pill">æ—¥æœŸï¼š<b id="pickedDate"></b></span>
    <span class="pill">ä»Šå¤©èŠ±è²»ï¼š<b id="dayTotal">0</b> å…ƒ</span>
  </div>

  <div class="card" style="padding:14px;">
    <h3 style="margin:0 0 8px; font-size:14px;">æ–°å¢ä¸€ç­†èŠ±è²»</h3>

    <label>å°è±¡</label>
    <select id="cat"></select>

    <label>åŸå› é¡å‹</label>
    <select id="reasonSel"></select>

    <div id="reasonOtherWrap" style="display:none;">
      <label>å…¶ä»–åŸå› ï¼ˆè‡ªå¡«ï¼‰</label>
      <input id="reasonOther" type="text" placeholder="ä¾‹ï¼šåœè»Šè²»ã€å¯„é€ã€ä»£è³¼æ‰‹çºŒè²»â€¦" />
    </div>

    <!-- âœ… å‚™è¨»ï¼šæ°¸é å¯å¡« -->
    <label>å‚™è¨»</label>
    <textarea id="note" rows="3" placeholder="ä¾‹ï¼šè²·äº†å“ªå€‹å‘¨é‚Š/åœ¨å“ªè£¡è²·/èª°ä»£è³¼â€¦"></textarea>

    <label>é‡‘é¡</label>
    <input id="amt" type="number" min="0" value="0" />

    <button class="btn primary" id="add">â• åŠ å…¥ä»Šå¤©</button>

    <div class="row" style="margin-top:10px;">
      <button class="btn" id="clearDecos">ğŸ§¹ æ¸…é™¤ä»Šå¤©è£é£¾</button>
      <button class="btn" id="clearDay"><span style="color:#b42318;">æ¸…ç©ºä»Šå¤©èŠ±è²»</span></button>
    </div>
  </div>

  <div class="card" style="padding:14px; margin-top:10px;">
    <h3 style="margin:0 0 8px; font-size:14px;">ä»Šæ—¥æ˜ç´°</h3>
    <table>
      <thead><tr><th>å°è±¡</th><th>åŸå› </th><th>å‚™è¨»</th><th class="right">é‡‘é¡</th></tr></thead>
      <tbody id="log"></tbody>
    </table>
  </div>
</div>

<script type="module">
  import { CATS, ymd, ymLabel, applyBackground } from "./assets/app.js";
  await applyBackground("planner");

  // ===== storage keys =====
  const EXP_KEY   = "oshi_expenses_v1";        // èŠ±è²»è³‡æ–™
  const ASSET_KEY = "oshi_deco_assets_v1";     // å…±ç”¨è²¼ç´™åº«ï¼ˆå­˜éŒ¢/èŠ±è²»å…±ç”¨ï¼‰
  const DECO_KEY  = "oshi_expense_decos_v1";   // èŠ±è²»æœˆæ›†è£é£¾ï¼ˆå„è‡ªä¸€ä»½ï¼‰

  // âœ… åŸå› é¸é …ï¼ˆå¯è‡ªè¡Œå¢æ¸›ï¼‰
  const REASONS = [
    "å‘¨é‚Š/ä»£è³¼",
    "äº¤é€š",
    "é¤é£²",
    "ä½å®¿",
    "æ´»å‹•/ç¥¨å‹™ç›¸é—œ",
    "æœƒå“¡/è¨‚é–±",
    "å…¶ä»–"
  ];

  const el = id => document.getElementById(id);
  const pad = n => String(n).padStart(2,"0");

  function loadExpenses(){
    const raw = localStorage.getItem(EXP_KEY);
    if(!raw) return { records:{} };
    try{
      const x = JSON.parse(raw);
      return x && x.records ? x : { records:{} };
    }catch{
      return { records:{} };
    }
  }
  function saveExpenses(x){
    localStorage.setItem(EXP_KEY, JSON.stringify(x));
  }

  function loadAssets(){
    try{ return JSON.parse(localStorage.getItem(ASSET_KEY)||"[]") || []; }
    catch{ return []; }
  }
  function saveAssets(arr){
    localStorage.setItem(ASSET_KEY, JSON.stringify(arr));
  }

  function loadDecos(){
    try{ return JSON.parse(localStorage.getItem(DECO_KEY)||"{}") || {}; }
    catch{ return {}; }
  }
  function saveDecos(obj){
    localStorage.setItem(DECO_KEY, JSON.stringify(obj));
  }

  function catClass(cat){
    if((cat||"").includes("Shokichi")) return "cat-shokichi";
    if((cat||"").includes("Akira")) return "cat-akira";
    return "cat-group";
  }

  function daySum(exp, dateKey){
    const arr = exp.records[dateKey] || [];
    return arr.reduce((s,r)=> s + (Number(r.amount)||0), 0);
  }

  function monthSum(exp, y, m){
    const prefix = `${y}-${pad(m+1)}-`;
    let s = 0;
    for(const k of Object.keys(exp.records||{})){
      if(!k.startsWith(prefix)) continue;
      s += daySum(exp, k);
    }
    return s;
  }

  function topRecord(exp, dateKey){
    const arr = exp.records[dateKey] || [];
    if(!arr.length) return null;
    return arr.reduce((best, r)=>{
      const a = Number(r.amount)||0;
      return !best || a > (Number(best.amount)||0) ? r : best;
    }, null);
  }

  function esc(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  // ===== calendar state =====
  let exp = loadExpenses();
  const today = new Date();
  let viewY = today.getFullYear();
  let viewM = today.getMonth();
  let pickedDate = ymd(today);

  function renderDow(){
    const names = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    el("dow").innerHTML = names.map(n=>`<div class="dow">${n}</div>`).join("");
  }

  // è£é£¾ï¼šæ¸²æŸ“ + å¯ç§»å‹•/åˆªé™¤/æ›¿æ›
  function renderDecosInCell(cell, dateKey){
    const decos = loadDecos();
    const list = decos[dateKey] || [];

    cell.querySelectorAll(".deco").forEach(x=>x.remove());

    for(const d of list){
      const div = document.createElement("div");
      div.className = "deco";
      div.style.left = (d.x ?? 10) + "px";
      div.style.top  = (d.y ?? 58) + "px";
      div.style.backgroundImage = `url('${d.src}')`;

      // é˜»æ“‹å–®æ“Šå†’æ³¡ï¼ˆé¿å…é»åˆ°æ ¼å­ï¼‰
      div.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); };

      // é›™æ“Šåˆªé™¤
      div.ondblclick = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        const decos2 = loadDecos();
        decos2[dateKey] = (decos2[dateKey]||[]).filter(x=>x !== d);
        saveDecos(decos2);
        renderCalendar();
      };

      // æ‹–ç§»è²¼ç´™ï¼ˆåœ¨æ ¼å­å…§æ‹–å‹•ä½ç½®ï¼‰
      div.onpointerdown = (e)=>{
        e.preventDefault();
        e.stopPropagation();
        div.setPointerCapture(e.pointerId);

        const startX = e.clientX;
        const startY = e.clientY;

        const rectCell = cell.getBoundingClientRect();
        const startLeft = parseInt(div.style.left || "0", 10);
        const startTop  = parseInt(div.style.top  || "0", 10);

        const move = (ev)=>{
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;

          let nx = startLeft + dx;
          let ny = startTop + dy;

          nx = Math.max(6, Math.min(rectCell.width - 40, nx));
          ny = Math.max(22, Math.min(rectCell.height - 40, ny));

          div.style.left = Math.round(nx) + "px";
          div.style.top  = Math.round(ny) + "px";
        };

        const up = ()=>{
          div.onpointermove = null;
          div.onpointerup = null;

          // å¯«å›å„²å­˜
          const decos2 = loadDecos();
          const arr = decos2[dateKey] || [];
          const idx = arr.indexOf(d);
          if(idx >= 0){
            arr[idx] = { ...arr[idx],
              x: parseInt(div.style.left, 10),
              y: parseInt(div.style.top, 10),
            };
            decos2[dateKey] = arr;
            saveDecos(decos2);
          }
        };

        div.onpointermove = move;
        div.onpointerup = up;
      };

      // å³éµæ›¿æ›åœ–ç‰‡
      div.oncontextmenu = (e)=>{
        e.preventDefault();
        e.stopPropagation();

        const assets = loadAssets();
        if(!assets.length){
          alert("ä½ çš„è²¼ç´™åº«ç›®å‰æ˜¯ç©ºçš„ï¼Œå…ˆåœ¨ä¸‹æ–¹ã€ï¼‹æ–°å¢è²¼ç´™ã€åŠ å…¥åœ–ç‰‡å§ï¼");
          return;
        }

        const msg =
          "è¼¸å…¥è¦æ›¿æ›æˆç¬¬å¹¾å¼µè²¼ç´™ï¼ˆ1 ~ " + assets.length + "ï¼‰\n" +
          "æç¤ºï¼šä½ å¯ä»¥å…ˆåœ¨ä¸‹æ–¹è²¼ç´™å€å¾å·¦åˆ°å³æ•¸ã€‚";
        const n = Number(prompt(msg));
        if(!Number.isFinite(n) || n < 1 || n > assets.length) return;

        const newSrc = assets[n-1];
        const decos2 = loadDecos();
        const arr = decos2[dateKey] || [];
        const idx = arr.indexOf(d);
        if(idx >= 0){
          arr[idx] = { ...arr[idx], src: newSrc };
          decos2[dateKey] = arr;
          saveDecos(decos2);
        }
        renderCalendar();
      };

      cell.appendChild(div);
    }
  }

  function renderCalendar(){
    el("ym").textContent = ymLabel(viewY, viewM);
    el("monthTotal").textContent = String(monthSum(exp, viewY, viewM));

    const first = new Date(viewY, viewM, 1);
    const start = new Date(viewY, viewM, 1 - first.getDay());

    const cells = [];
    for(let i=0;i<42;i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      const key = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const outside = d.getMonth() !== viewM;

      const sum = daySum(exp, key);
      const has = sum > 0;
      const top = has ? topRecord(exp, key) : null;

      cells.push(`
        <div class="cell ${outside?"outside":""} ${has?"has-spend":"no-spend"}" data-date="${key}">
          <div class="date">${d.getDate()}</div>
          <div class="sum">${sum} å…ƒ</div>
          ${top ? `<div class="topcat ${catClass(top.cat||"")}">${esc(top.cat||"")}</div>` : ""}
        </div>
      `);
    }
    el("cal").innerHTML = cells.join("");

    document.querySelectorAll(".cell").forEach(c=>{
      const dateKey = c.dataset.date;

      c.addEventListener("click", ()=>openDay(dateKey));

      // æ‹–æ›³è²¼ç´™é€²ä¾†
      c.addEventListener("dragover", (e)=>{ e.preventDefault(); });
      c.addEventListener("drop", (e)=>{
        e.preventDefault();
        const src = e.dataTransfer.getData("text/plain");
        if(!src) return;

        const rect = c.getBoundingClientRect();
        const x = Math.max(6, Math.min(rect.width - 40, e.clientX - rect.left - 16));
        const y = Math.max(22, Math.min(rect.height - 40, e.clientY - rect.top - 16));

        const decos = loadDecos();
        if(!decos[dateKey]) decos[dateKey] = [];
        decos[dateKey].push({ src, x: Math.round(x), y: Math.round(y) });
        saveDecos(decos);

        renderDecosInCell(c, dateKey);
      });

      renderDecosInCell(c, dateKey);
    });
  }

  function renderAssetTray(){
    const assets = loadAssets();
    el("assetTray").innerHTML = assets.map((src)=>`
      <img class="assetItem" draggable="true" src="${src}" alt="asset">
    `).join("");

    document.querySelectorAll(".assetItem").forEach(img=>{
      img.addEventListener("dragstart", (e)=>{
        e.dataTransfer.setData("text/plain", img.src);
      });
    });
  }

  // ===== panel =====
  function syncReasonOther(){
    const isOther = el("reasonSel").value === "å…¶ä»–";
    el("reasonOtherWrap").style.display = isOther ? "block" : "none";
    if(!isOther) el("reasonOther").value = "";
  }

  function openDay(dateKey){
    pickedDate = dateKey;
    el("pickedDate").textContent = pickedDate;

    // å°è±¡
    el("cat").innerHTML = CATS.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");

    // åŸå› é¸å–®
    el("reasonSel").innerHTML = REASONS.map(r=>`<option value="${esc(r)}">${esc(r)}</option>`).join("");
    el("reasonSel").value = REASONS[0];
    syncReasonOther();

    el("overlay").classList.add("show");
    el("panel").classList.add("open");
    renderDay();
  }

  function closeDay(){
    el("overlay").classList.remove("show");
    el("panel").classList.remove("open");
  }

  el("reasonSel").addEventListener("change", syncReasonOther);

  function renderDay(){
    el("dayTotal").textContent = String(daySum(exp, pickedDate));
    const arr = exp.records[pickedDate] || [];

    el("log").innerHTML = arr.length
      ? arr.slice().reverse().map(r=>`
        <tr>
          <td>${esc(r.cat)}</td>
          <td>${esc(r.reason)}</td>
          <td>${esc(r.note)}</td>
          <td class="right">${Number(r.amount)||0}</td>
        </tr>
      `).join("")
      : `<tr><td colspan="4" style="color:var(--muted); padding:14px;">ä»Šå¤©é‚„æ²’æœ‰èŠ±è²»</td></tr>`;
  }

  // âœ… æ–°å¢èŠ±è²»ï¼ˆä¿®æ­£ï¼šå‚™è¨»æ°¸é ç¨ç«‹ï¼Œä¸å—ã€Œå…¶ä»–ã€å½±éŸ¿ï¼‰
  el("add").addEventListener("click", ()=>{
    const cat = el("cat").value;

    // åŸå› ï¼šæ˜¯å¦ç‚ºã€Œå…¶ä»–ã€åªå½±éŸ¿ reasonï¼Œä¸å½±éŸ¿ note
    let reason = el("reasonSel").value;
    if(reason === "å…¶ä»–"){
      const custom = (el("reasonOther").value || "").trim();
      if(custom){
        reason = `å…¶ä»–ï¼š${custom}`;
      } else {
        reason = "å…¶ä»–";
      }
    }

    // å‚™è¨»ï¼šæ°¸é å¯å¡«
    const note = (el("note").value || "").trim();
    const amount = Math.max(0, Number(el("amt").value || 0));

    if(!exp.records[pickedDate]) exp.records[pickedDate] = [];
    exp.records[pickedDate].push({ cat, reason, note, amount, ts: Date.now() });

    saveExpenses(exp);
    renderDay();
    renderCalendar();

    // æ¸…ç©ºè¼¸å…¥ï¼ˆä¿ç•™å°è±¡ï¼‰
    el("note").value = "";
    el("amt").value = 0;

    // è‹¥ç•¶ä¸‹æ˜¯å…¶ä»–å°±æ¸…æ‰è‡ªå¡«æ¬„
    if(el("reasonSel").value === "å…¶ä»–"){
      el("reasonOther").value = "";
    }
  });

  // æ¸…ç©ºä»Šå¤©èŠ±è²»
  el("clearDay").addEventListener("click", ()=>{
    if(confirm("ç¢ºå®šæ¸…ç©ºä»Šå¤©å…¨éƒ¨èŠ±è²»ï¼Ÿ")){
      delete exp.records[pickedDate];
      saveExpenses(exp);
      renderDay();
      renderCalendar();
    }
  });

  // æ¸…é™¤ä»Šå¤©è£é£¾
  el("clearDecos").addEventListener("click", ()=>{
    if(confirm("ç¢ºå®šæ¸…é™¤ä»Šå¤©æ—¥æœŸæ ¼å­çš„å…¨éƒ¨è£é£¾ï¼Ÿ")){
      const decos = loadDecos();
      delete decos[pickedDate];
      saveDecos(decos);
      renderCalendar();
      alert("å·²æ¸…é™¤ä»Šå¤©è£é£¾ï¼");
    }
  });

  // æœˆä»½åˆ‡æ›
  el("prev").addEventListener("click", ()=>{
    viewM -= 1;
    if(viewM<0){ viewM=11; viewY-=1; }
    renderCalendar();
  });
  el("next").addEventListener("click", ()=>{
    viewM += 1;
    if(viewM>11){ viewM=0; viewY+=1; }
    renderCalendar();
  });

  // é¢æ¿é—œé–‰
  el("overlay").addEventListener("click", closeDay);
  el("close").addEventListener("click", closeDay);

  // è²¼ç´™åº«æŒ‰éˆ•
  el("addAssets").onclick = ()=> el("assetPicker").click();
  el("assetPicker").onchange = async (e)=>{
    const files = Array.from(e.target.files || []);
    if(!files.length) return;

    const assets = loadAssets();
    for(const f of files){
      const dataUrl = await new Promise((res)=>{
        const r = new FileReader();
        r.onload = ()=>res(String(r.result));
        r.readAsDataURL(f);
      });
      assets.push(dataUrl);
    }
    saveAssets(assets);
    renderAssetTray();
    el("assetPicker").value = "";
  };

  el("clearAssets").onclick = ()=>{
    if(confirm("ç¢ºå®šæ¸…ç©ºè²¼ç´™åº«ï¼Ÿï¼ˆä¸æœƒåˆªä½ å·²è²¼åˆ°æ—¥æœŸä¸Šçš„è£é£¾ï¼‰")){
      saveAssets([]);
      renderAssetTray();
    }
  };

  // åˆå§‹åŒ–
  renderDow();
  renderCalendar();
  renderAssetTray();

  window.addEventListener("focus", async ()=>{
    exp = loadExpenses();
    await applyBackground("planner");
    renderCalendar();
  });
</script>
</body>
</html>
