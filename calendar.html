<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>追星存錢｜月曆版</title>
  <link rel="stylesheet" href="assets/app.css" />
  <style>
    .calendar{display:grid; grid-template-columns: repeat(7, 1fr); gap:10px;}
    .dow{color:var(--muted); font-size:12px; padding:0 2px 6px;}
    .cell{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.70);
      min-height:112px;
      padding:12px;
      cursor:pointer;
      position:relative;
      transition:.12s transform ease, .12s opacity ease;
    }
    .cell:hover{transform: translateY(-1px); opacity:.96;}
    .date{font-weight:800; font-size:14px;}
    .muted{color:var(--muted); font-size:12px; margin-top:4px;}
    .sum{margin-top:8px; font-weight:900; font-size:14px;}
    .outside{opacity:.35}

    /* 有存錢日期：亮色紙張 */
    .cell.has-money{
      background:#ffffff;
      border-color:#e6e2d9;
      box-shadow:
        0 12px 24px rgba(0,0,0,.08),
        0 2px 0 rgba(0,0,0,.03);
    }
/* === 沒存錢：更暗（對比更強） === */
.cell.no-money{
  background: rgba(120,120,120,.12);   /* 灰霧底 */
  border-color: rgba(120,120,120,.22);
  box-shadow: none;
}

/* 沒存錢時，文字也更淡 */
.cell.no-money .sum{
  color: rgba(43,43,43,.45);
}
.cell.no-money .muted{
  color: rgba(43,43,43,.35);
}

/* 沒存錢時不要顯示貼紙/標籤（保險） */
.cell.no-money .sticker,
.cell.no-money .topcat{
  display:none;
}


    /* ===== 存款對象貼紙（顏色） ===== */
    .topcat{
      margin-top:6px;
      display:inline-flex;
      align-items:center;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      border:1px solid transparent;
    }

    /* Shokichi：橘紅 */
    .cat-shokichi{
      background: rgba(226, 88, 34, .14);
      color: #c2410c;
      border-color: rgba(226, 88, 34, .35);
    }

    /* Akira：黑金 */
    .cat-akira{
      background: rgba(32, 32, 32, .08);
      color: #1f1f1f;
      border-color: rgba(180, 150, 90, .55);
      box-shadow: inset 0 0 0 1px rgba(180,150,90,.25);
    }

    /* 團體：森林綠 */
    .cat-group{
      background: rgba(34, 139, 34, .14);
      color: #166534;
      border-color: rgba(34, 139, 34, .35);
    }

    /* 右上角貼紙（最高金額那筆的 reward） */
    .sticker{
      position:absolute;
      right:10px; top:10px;
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(157,183,198,.45);
      background-color: rgba(255,255,255,.45);
      background-size: cover;
      background-position: center;
      box-shadow: 0 8px 18px rgba(0,0,0,.12);
    }

    /* 側邊面板 */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; z-index:20;}
    .panel{
      position:fixed; right:0; top:0; height:100%; width:min(460px, 100%);
      background: rgba(255,255,255,.96);
      border-left:1px solid var(--line);
      transform: translateX(100%);
      transition:.18s transform ease;
      z-index:21;
      padding:16px;
      overflow:auto;
      backdrop-filter: blur(10px);
    }
    .panel.open{transform: translateX(0);}
    .overlay.show{display:block;}
    .x{float:right; font-size:14px; padding:8px 10px; border-radius:999px;}

    table{background:white}
    th{background:#faf9f6}
    .right{text-align:right}

    .thumb{
      width:44px;height:44px;
      border-radius:12px;
      border:1px solid var(--line);
      object-fit:cover;
      background:#faf9f6;
    }
  </style>
</head>
<body>
<div class="bg-wrap"></div>

<header>
  <h1>月曆版存錢</h1>
  <div class="sub"><a href="index.html">← 回首頁</a></div>
</header>

<main>
  <div class="row" style="margin-bottom:12px; justify-content:space-between;">
    <div class="row">
      <button class="btn" id="prev">◀ 上個月</button>
      <span class="pill">月份：<b id="ym"></b></span>
      <button class="btn" id="next">下個月 ▶</button>
    </div>
    <span class="pill">本月累計：<b id="monthTotal">0</b> 元</span>
  </div>

  <div class="calendar" id="dow"></div>
  <div class="calendar" id="cal"></div>
</main>

<div class="overlay" id="overlay"></div>
<div class="panel" id="panel">
  <button class="btn x" id="close">✕</button>

  <h2 style="margin:0 0 10px; font-size:15px;">每日紀錄</h2>

  <div class="row" style="margin-bottom:10px;">
    <span class="pill">日期：<b id="pickedDate"></b></span>
    <span class="pill">今天累計：<b id="dayTotal">0</b> 元</span>
  </div>

  <div class="card" style="padding:14px;">
    <label>分類（存款對象）</label>
    <select id="cat"></select>

    <label>事件</label>
    <select id="event"></select>

    <div class="row">
      <div style="flex:1 1 140px;">
        <label>次數</label>
        <input id="times" type="number" min="1" value="1" />
      </div>
      <div style="flex:1 1 180px;">
        <label>本次金額</label>
        <input id="amt" type="number" disabled />
      </div>
    </div>

    <button class="btn primary" id="add">➕ 加入今天</button>
  </div>

  <div class="card" style="padding:14px; margin-top:10px;">
    <table>
      <thead>
        <tr><th></th><th>存款對象</th><th>事件</th><th class="right">金額</th></tr>
      </thead>
      <tbody id="log"></tbody>
    </table>
  </div>
</div>

<script type="module">
import {
  CATS, loadData, saveData, ymd, ymLabel,
  monthSum, daySum, pickRewardImage, daySticker, applyBackground
} from "./assets/app.js";

await applyBackground("planner");

const el = id => document.getElementById(id);
let data = loadData();

const today = new Date();
let viewY = today.getFullYear();
let viewM = today.getMonth();
let pickedDate = ymd(today);

function renderDow(){
  el("dow").innerHTML = ["日","一","二","三","四","五","六"]
    .map(n=>`<div class="dow">${n}</div>`).join("");
}

/* 取最高金額那筆 */
function topRecord(dateKey){
  const arr = data.records[dateKey] || [];
  if(!arr.length) return null;
  return arr.reduce((best, r)=>{
    const a = Number(r.amount)||0;
    return !best || a > (Number(best.amount)||0) ? r : best;
  }, null);
}

/* 對應顏色 class */
function catClass(cat){
  if(cat.includes("Shokichi")) return "cat-shokichi";
  if(cat.includes("Akira")) return "cat-akira";
  return "cat-group";
}

function renderCalendar(){
  el("ym").textContent = ymLabel(viewY, viewM);
  el("monthTotal").textContent = String(monthSum(data, viewY, viewM, ""));

  const first = new Date(viewY, viewM, 1);
  const start = new Date(viewY, viewM, 1 - first.getDay());

  const cells = [];
  for(let i=0;i<42;i++){
    const d = new Date(start);
    d.setDate(start.getDate()+i);
    const key = ymd(d);
    const outside = d.getMonth() !== viewM;

    const sum = daySum(data, key, "");
    const has = sum > 0;
    const rec = has ? topRecord(key) : null;
    const sticker = rec ? rec.rewardImg : "";

    cells.push(`
      <div class="cell ${outside?"outside":""} ${has?"has-money":"no-money"}" data-date="${key}">
        <div class="date">${d.getDate()}</div>
        <div class="sum">${sum} 元</div>
        ${rec ? `<div class="topcat ${catClass(rec.cat)}">${rec.cat}</div>` : ""}
        ${sticker ? `<div class="sticker" style="background-image:url('${sticker}')"></div>` : ""}
      </div>
    `);
  }

  el("cal").innerHTML = cells.join("");
  document.querySelectorAll(".cell").forEach(c=>{
    c.addEventListener("click", ()=>openDay(c.dataset.date));
  });
}

function openDay(key){
  pickedDate = key;
  el("overlay").classList.add("show");
  el("panel").classList.add("open");

  el("pickedDate").textContent = pickedDate;
  el("cat").innerHTML = CATS.map(c=>`<option>${c}</option>`).join("");
  el("event").innerHTML = Object.keys(data.rules).map(e=>`<option>${e}</option>`).join("");

  renderDay();
}

function renderDay(){
  el("dayTotal").textContent = String(daySum(data, pickedDate, ""));
  const arr = data.records[pickedDate] || [];
  el("log").innerHTML = arr.length
    ? arr.slice().reverse().map(r=>`
      <tr>
        <td>${r.rewardImg?`<img class="thumb" src="${r.rewardImg}">`:""}</td>
        <td>${r.cat}</td>
        <td>${r.event}</td>
        <td class="right">${r.amount}</td>
      </tr>
    `).join("")
    : `<tr><td colspan="4" style="color:var(--muted);padding:14px;">今天還沒有紀錄</td></tr>`;
}

el("add").onclick = async ()=>{
  const cat = el("cat").value;
  const event = el("event").value;
  const unit = Number(data.rules[event]||0);
  const times = Math.max(1, Number(el("times").value||1));
  const amount = unit * times;
  const rewardImg = await pickRewardImage();

  if(!data.records[pickedDate]) data.records[pickedDate] = [];
  data.records[pickedDate].push({cat,event,times,amount,rewardImg,ts:Date.now()});
  saveData(data);
  renderDay();
  renderCalendar();
};

el("prev").onclick = ()=>{ viewM--; if(viewM<0){viewM=11;viewY--;} renderCalendar(); };
el("next").onclick = ()=>{ viewM++; if(viewM>11){viewM=0;viewY++;} renderCalendar(); };

el("overlay").onclick = ()=>{ el("overlay").classList.remove("show"); el("panel").classList.remove("open"); };
el("close").onclick = ()=>{ el("overlay").classList.remove("show"); el("panel").classList.remove("open"); };

renderDow();
renderCalendar();
</script>
</body>
</html>

