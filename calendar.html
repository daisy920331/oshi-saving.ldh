<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¿½æ˜Ÿå­˜éŒ¢ï½œæœˆæ›†ç‰ˆ</title>
  <link rel="stylesheet" href="assets/app.css" />
  <style>
    .wrap{max-width:980px;margin:0 auto;padding:18px 16px 40px;}
    .calendar{display:grid; grid-template-columns: repeat(7, 1fr); gap:10px;}
    .dow{color:var(--muted); font-size:12px; padding:0 2px 6px;}

    /* æœˆä»½åˆ—ï¼šç½®ä¸­ */
    .monthbar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .monthbar .left{justify-self:start}
    .monthbar .center{justify-self:center}
    .monthbar .right{justify-self:end}

    .cell{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.70);
      min-height:120px;
      padding:12px;
      cursor:pointer;
      position:relative;
      transition:.12s transform ease, .12s opacity ease;
      overflow:hidden;
    }
    .cell:hover{transform: translateY(-1px); opacity:.96;}
    .date{font-weight:800; font-size:14px;}
    .sum{margin-top:6px; font-weight:900; font-size:14px;}
    .outside{opacity:.30}

    /* âœ… æœ‰å­˜éŒ¢ï¼šäº® */
    .cell.has-money{
      background:#ffffff;
      border-color:#e6e2d9;
      box-shadow: 0 12px 24px rgba(0,0,0,.08), 0 2px 0 rgba(0,0,0,.03);
    }
    /* âœ… æ²’å­˜éŒ¢ï¼šæš— */
    .cell.no-money{
      background: rgba(90,90,90,.16);
      border-color: rgba(90,90,90,.22);
      box-shadow:none;
    }
    .cell.no-money .sum{color: rgba(20,20,20,.55);}

    /* é¡¯ç¤ºï¼šç•¶æ—¥æœ€é«˜é‡‘é¡é‚£ç­†çš„å­˜æ¬¾å°è±¡ï¼ˆä¸Šè‰²è²¼ç´™æ¨™ç±¤ï¼‰ */
    .topcat{
      margin-top:6px;
      display:inline-flex;
      align-items:center;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid transparent;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      background:#faf9f6;
    }
    .cat-shokichi{background: rgba(226, 88, 34, .14); color:#c2410c; border-color: rgba(226, 88, 34, .35);}
    .cat-akira{background: rgba(32, 32, 32, .08); color:#1f1f1f; border-color: rgba(180,150,90,.55); box-shadow: inset 0 0 0 1px rgba(180,150,90,.25);}
    .cat-group{background: rgba(34, 139, 34, .14); color:#166534; border-color: rgba(34, 139, 34, .35);}

    /* ç•¶æ—¥è²¼ç´™ï¼ˆæœ€å¤§é‡‘é¡é‚£ç­† rewardï¼‰ */
    .sticker{
      position:absolute; right:10px; top:10px;
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(157,183,198,.45);
      background-color: rgba(255,255,255,.45);
      background-size: cover;
      background-position: center;
      box-shadow: 0 8px 18px rgba(0,0,0,.12);
    }

    /* âœ… è£é£¾è²¼ç´™ï¼ˆå¯æ‹–æ›³ï¼‰â€” æœƒå‡ºç¾åœ¨æ—¥æœŸæ ¼å­å…§ */
    .deco{
      position:absolute;
      width:34px;height:34px;
      border-radius:10px;
      background-size:cover;
      background-position:center;
      box-shadow:0 10px 18px rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.55);
      cursor:grab;
    }

    /* å´é‚Šé¢æ¿ */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; z-index:20;}
    .panel{
      position:fixed; right:0; top:0; height:100%; width:min(480px, 100%);
      background: rgba(255,255,255,.96);
      border-left:1px solid var(--line);
      transform: translateX(100%); transition:.18s transform ease;
      z-index:21; padding:16px; overflow:auto; backdrop-filter: blur(10px);
    }
    .panel.open{transform: translateX(0);}
    .overlay.show{display:block;}
    .x{float:right; font-size:14px; padding:8px 10px; border-radius:999px;}

    table{background:white}
    th{background:#faf9f6}
    .right{text-align:right}
    .thumb{width:44px;height:44px;border-radius:12px;border:1px solid var(--line);object-fit:cover;background:#faf9f6;}

    /* åº•éƒ¨è²¼ç´™å€ */
    .assetBar{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.85);
      padding:12px;
      box-shadow:0 10px 22px rgba(0,0,0,.06), 0 2px 0 rgba(0,0,0,.02);
    }
    .assetRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .assetTray{
      margin-top:10px;
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:4px;
    }
    .assetItem{
      width:52px;height:52px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#faf9f6;
      object-fit:cover;
      flex:0 0 auto;
      cursor:grab;
    }
    .smallHint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div class="bg-wrap"></div>

<header>
  <h1>æœˆæ›†ç‰ˆå­˜éŒ¢</h1>
  <div class="sub"><a href="index.html">â† å›é¦–é </a></div>
</header>

<div class="wrap">
  <div class="monthbar">
    <div class="left"><button class="btn" id="prev">â—€ ä¸Šå€‹æœˆ</button></div>
    <div class="center"><span class="pill">æœˆä»½ï¼š<b id="ym"></b></span></div>
    <div class="right"><button class="btn" id="next">ä¸‹å€‹æœˆ â–¶</button></div>
  </div>

  <div class="row" style="justify-content:space-between;margin-bottom:10px;">
    <span class="pill">æœ¬æœˆç´¯è¨ˆï¼š<b id="monthTotal">0</b> å…ƒ</span>
    <span class="pill">æç¤ºï¼šå­˜éŒ¢æ—¥äº®ã€æ²’å­˜éŒ¢æš—</span>
  </div>

  <div class="calendar" id="dow"></div>
  <div class="calendar" id="cal"></div>

  <!-- âœ… åº•éƒ¨è²¼ç´™/å°ç…§ç‰‡å€ -->
  <div class="assetBar">
    <div class="assetRow">
      <b>å°è²¼ç´™ / å°ç…§ç‰‡</b>
      <div class="row">
        <input id="assetPicker" type="file" accept="image/*" multiple style="display:none"/>
        <button class="btn" id="addAssets">ï¼‹æ–°å¢è²¼ç´™</button>
        <button class="btn" id="clearAssets"><span style="color:#b42318">æ¸…ç©ºè²¼ç´™åº«</span></button>
      </div>
    </div>
    <div class="smallHint">æ‹–æ›³ä¸‹æ–¹è²¼ç´™åˆ°ã€Œæ—¥æœŸæ ¼å­ã€ä¸Šå³å¯è£é£¾ã€‚é›™æ“Šæ ¼å­ä¸Šçš„è£é£¾å¯åˆªé™¤ã€‚</div>
    <div class="assetTray" id="assetTray"></div>
  </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="panel" id="panel">
  <button class="btn x" id="close">âœ•</button>

  <h2 style="margin:0 0 10px; font-size:15px;">æ¯æ—¥ç´€éŒ„</h2>

  <div class="row" style="margin-bottom:10px;">
    <span class="pill">æ—¥æœŸï¼š<b id="pickedDate"></b></span>
    <span class="pill">ä»Šå¤©ç´¯è¨ˆï¼š<b id="dayTotal">0</b> å…ƒ</span>
  </div>

  <div class="card" style="padding:14px;">
    <h3 style="margin:0 0 8px; font-size:14px;">æ–°å¢ä¸€ç­†</h3>

    <label>åˆ†é¡ï¼ˆå­˜æ¬¾å°è±¡ï¼‰</label>
    <select id="cat"></select>

    <label>äº‹ä»¶</label>
    <select id="event"></select>

    <div class="row">
      <div style="flex:1 1 120px;">
        <label>æ¬¡æ•¸</label>
        <input id="times" type="number" min="1" value="1" />
      </div>
      <div style="flex:1 1 180px;">
        <label>é‡‘é¡ï¼ˆè‡ªå‹•/è‡ªè¨‚ï¼‰</label>
        <input id="amt" type="number" disabled />
      </div>
    </div>

    <!-- âœ… è‡ªè¨‚é‡‘é¡æ”¾å›ä¾† -->
    <div class="row" style="margin-top:10px;align-items:center;">
      <label style="margin:0;display:flex;gap:8px;align-items:center;">
        <input type="checkbox" id="useCustomAmt" />
        ä½¿ç”¨è‡ªè¨‚é‡‘é¡
      </label>
      <input id="customAmt" type="number" min="0" value="0" style="flex:1 1 160px;" disabled />
    </div>

    <button class="btn primary" id="add">â• åŠ å…¥ä»Šå¤©</button>
    <div class="hint">è‡ªè¨‚é‡‘é¡æœƒè¦†è“‹äº‹ä»¶é‡‘é¡Ã—æ¬¡æ•¸ã€‚</div>
  </div>

  <!-- äº‹ä»¶é‡‘é¡è¨­å®šï¼šåœ¨é€™è£¡æ”¹ï¼Œä¸æœƒå½±éŸ¿èˆŠç´€éŒ„ -->
  <div class="card" style="padding:14px; margin-top:10px;">
    <h3 style="margin:0 0 8px; font-size:14px;">äº‹ä»¶é‡‘é¡è¨­å®š</h3>
    <label>é¸äº‹ä»¶</label>
    <select id="editEvent"></select>
    <label>é‡‘é¡ï¼ˆå…ƒï¼‰</label>
    <input id="editAmount" type="number" min="0" value="0" />
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="saveRule">ğŸ’¾ å„²å­˜é‡‘é¡</button>
      <button class="btn" id="addEvent">âœ¨ æ–°å¢è‡ªè¨‚äº‹ä»¶</button>
    </div>
  </div>

  <div class="card" style="padding:14px; margin-top:10px;">
    <h3 style="margin:0 0 8px; font-size:14px;">ä»Šæ—¥æ˜ç´°</h3>
    <table>
      <thead><tr><th>é¼“å‹µ</th><th>å°è±¡</th><th>äº‹ä»¶</th><th class="right">é‡‘é¡</th></tr></thead>
      <tbody id="log"></tbody>
    </table>
    <button class="btn" id="clearDay" style="margin-top:10px;"><span style="color:#b42318;">æ¸…ç©ºä»Šå¤©</span></button>
  </div>
</div>

<script type="module">
  import {
    CATS, loadData, saveData, ymd, ymLabel, monthSum, daySum,
    pickRewardImage, daySticker, applyBackground
  } from "./assets/app.js";

  await applyBackground("planner");

  const ASSET_KEY = "oshi_deco_assets_v1";
  const DECO_KEY  = "oshi_calendar_decos_v1"; // {date:[{src,x,y}]}

  const el = id => document.getElementById(id);
  let data = loadData();

  const today = new Date();
  let viewY = today.getFullYear();
  let viewM = today.getMonth();
  let pickedDate = ymd(today);

  function loadAssets(){
    try{ return JSON.parse(localStorage.getItem(ASSET_KEY)||"[]") || []; }
    catch{ return []; }
  }
  function saveAssets(arr){
    localStorage.setItem(ASSET_KEY, JSON.stringify(arr));
  }
  function loadDecos(){
    try{ return JSON.parse(localStorage.getItem(DECO_KEY)||"{}") || {}; }
    catch{ return {}; }
  }
  function saveDecos(obj){
    localStorage.setItem(DECO_KEY, JSON.stringify(obj));
  }

  function catClass(cat){
    if((cat||"").includes("Shokichi")) return "cat-shokichi";
    if((cat||"").includes("Akira")) return "cat-akira";
    return "cat-group";
  }

  function renderDow(){
    const names = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    el("dow").innerHTML = names.map(n=>`<div class="dow">${n}</div>`).join("");
  }

  function topRecord(dateKey){
    const arr = data.records[dateKey] || [];
    if(!arr.length) return null;
    return arr.reduce((best, r)=>{
      const a = Number(r.amount)||0;
      return !best || a > (Number(best.amount)||0) ? r : best;
    }, null);
  }

  function renderDecosInCell(cell, dateKey){
    const decos = loadDecos();
    const list = decos[dateKey] || [];
    // æ¸…æ‰èˆŠçš„
    cell.querySelectorAll(".deco").forEach(x=>x.remove());

    for(const d of list){
      const div = document.createElement("div");
      div.className = "deco";
      div.style.left = (d.x ?? 10) + "px";
      div.style.top  = (d.y ?? 58) + "px";
      div.style.backgroundImage = `url('${d.src}')`;

      // é›™æ“Šåˆªé™¤
      div.ondblclick = (e)=>{
        e.stopPropagation();
        const decos2 = loadDecos();
        decos2[dateKey] = (decos2[dateKey]||[]).filter(x=>x !== d);
        saveDecos(decos2);
        renderCalendar();
      };

      cell.appendChild(div);
    }
  }

  function renderCalendar(){
    el("ym").textContent = ymLabel(viewY, viewM);
    el("monthTotal").textContent = String(monthSum(data, viewY, viewM, ""));

    const first = new Date(viewY, viewM, 1);
    const start = new Date(viewY, viewM, 1 - first.getDay());

    const cells = [];
    for(let i=0;i<42;i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      const key = ymd(d);
      const outside = d.getMonth() !== viewM;

      const sum = daySum(data, key, "");
      const has = sum > 0;

      const rec = has ? topRecord(key) : null;
      const sticker = rec ? (rec.rewardImg || "") : "";
      const catTag = rec ? (rec.cat || "") : "";

      cells.push(`
        <div class="cell ${outside?"outside":""} ${has?"has-money":"no-money"}" data-date="${key}">
          <div class="date">${d.getDate()}</div>
          <div class="sum">${sum} å…ƒ</div>
          ${rec ? `<div class="topcat ${catClass(catTag)}">${catTag}</div>` : ""}
          ${sticker ? `<div class="sticker" style="background-image:url('${sticker}')"></div>` : ""}
        </div>
      `);
    }
    el("cal").innerHTML = cells.join("");

    document.querySelectorAll(".cell").forEach(c=>{
      const dateKey = c.dataset.date;

      // é»æ ¼å­é–‹é¢æ¿
      c.addEventListener("click", ()=>openDay(dateKey));

      // æ‹–æ›³è²¼ç´™é€²ä¾†
      c.addEventListener("dragover", (e)=>{ e.preventDefault(); });
      c.addEventListener("drop", (e)=>{
        e.preventDefault();
        const src = e.dataTransfer.getData("text/plain");
        if(!src) return;

        const rect = c.getBoundingClientRect();
        const x = Math.max(6, Math.min(rect.width - 40, e.clientX - rect.left - 16));
        const y = Math.max(22, Math.min(rect.height - 40, e.clientY - rect.top - 16));

        const decos = loadDecos();
        if(!decos[dateKey]) decos[dateKey] = [];
        decos[dateKey].push({ src, x: Math.round(x), y: Math.round(y) });
        saveDecos(decos);

        renderDecosInCell(c, dateKey);
      });

      renderDecosInCell(c, dateKey);
    });
  }

  function fillPanel(){
    el("cat").innerHTML = CATS.map(c=>`<option value="${c}">${c}</option>`).join("");

    const events = Object.keys(data.rules || {});
    el("event").innerHTML = events.map(e=>`<option value="${e}">${e}</option>`).join("");
    el("editEvent").innerHTML = events.map(e=>`<option value="${e}">${e}</option>`).join("");

    syncAmt();
    syncEditAmount();
  }

  function syncAmt(){
    const e = el("event").value;
    const times = Math.max(1, Number(el("times").value || 1));
    const unit = Number((data.rules||{})[e] || 0);
    el("amt").value = unit * times;
  }
  function syncEditAmount(){
    const e = el("editEvent").value;
    el("editAmount").value = Number((data.rules||{})[e] || 0);
  }

  function renderDay(){
    el("pickedDate").textContent = pickedDate;
    const arr = data.records[pickedDate] || [];
    el("dayTotal").textContent = String(daySum(data, pickedDate, ""));

    const rows = arr.slice().reverse().map(x=>`
      <tr>
        <td>${x.rewardImg ? `<img class="thumb" src="${x.rewardImg}" alt="reward">` : ""}</td>
        <td>${x.cat||""}</td>
        <td>${x.event||""}${x.times>1 ? ` Ã—${x.times}`:""}</td>
        <td class="right">${Number(x.amount)||0}</td>
      </tr>
    `).join("");

    el("log").innerHTML = rows || `<tr><td colspan="4" style="color:var(--muted); padding:14px;">ä»Šå¤©é‚„æ²’æœ‰ç´€éŒ„</td></tr>`;
  }

  function openDay(dateKey){
    pickedDate = dateKey;
    el("overlay").classList.add("show");
    el("panel").classList.add("open");
    fillPanel();
    renderDay();
  }
  function closeDay(){
    el("overlay").classList.remove("show");
    el("panel").classList.remove("open");
  }

  // âœ… è‡ªè¨‚é‡‘é¡é–‹é—œ
  el("useCustomAmt").addEventListener("change", ()=>{
    const on = el("useCustomAmt").checked;
    el("customAmt").disabled = !on;
    if(!on) el("customAmt").value = 0;
  });

  el("times").addEventListener("input", ()=>{
    if(Number(el("times").value)<1) el("times").value=1;
    syncAmt();
  });
  el("event").addEventListener("change", syncAmt);
  el("editEvent").addEventListener("change", syncEditAmount);

  el("add").addEventListener("click", async ()=>{
    const cat = el("cat").value;
    const event = el("event").value;
    const times = Math.max(1, Number(el("times").value||1));

    const unit = Number((data.rules||{})[event]||0);
    let amount = unit * times;

    if(el("useCustomAmt").checked){
      amount = Math.max(0, Number(el("customAmt").value||0));
    }

    const rewardImg = await pickRewardImage();

    if(!data.records[pickedDate]) data.records[pickedDate] = [];
    data.records[pickedDate].push({ cat, event, times, amount, rewardImg, ts: Date.now() });

    saveData(data);
    renderDay();
    renderCalendar();
  });

  el("clearDay").addEventListener("click", ()=>{
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºä»Šå¤©å…¨éƒ¨ç´€éŒ„ï¼Ÿ")){
      delete data.records[pickedDate];
      saveData(data);
      renderDay();
      renderCalendar();
    }
  });

  el("saveRule").addEventListener("click", ()=>{
    const e = el("editEvent").value;
    const amt = Math.max(0, Number(el("editAmount").value||0));
    if(!data.rules) data.rules = {};
    data.rules[e] = amt;
    saveData(data);
    syncAmt();
    alert("å·²å„²å­˜é‡‘é¡ï¼");
  });

  el("addEvent").addEventListener("click", ()=>{
    const name = prompt("è¼¸å…¥æ–°äº‹ä»¶åç¨±ï¼š");
    if(!name) return;
    const k = name.trim();
    if(!k) return;
    if(!data.rules) data.rules = {};
    if(Object.prototype.hasOwnProperty.call(data.rules, k)){
      alert("äº‹ä»¶å·²å­˜åœ¨ï¼");
      return;
    }
    data.rules[k] = 0;
    saveData(data);
    fillPanel();
    alert("å·²æ–°å¢äº‹ä»¶ï¼ˆé‡‘é¡å…ˆè¨­ 0ï¼‰");
  });

  // æœˆä»½åˆ‡æ›
  el("prev").addEventListener("click", ()=>{
    viewM -= 1;
    if(viewM<0){ viewM=11; viewY-=1; }
    renderCalendar();
  });
  el("next").addEventListener("click", ()=>{
    viewM += 1;
    if(viewM>11){ viewM=0; viewY+=1; }
    renderCalendar();
  });

  // é¢æ¿é—œé–‰
  el("overlay").addEventListener("click", closeDay);
  el("close").addEventListener("click", closeDay);

  // åº•éƒ¨è²¼ç´™åº«
  function renderAssetTray(){
    const assets = loadAssets();
    el("assetTray").innerHTML = assets.map((src, idx)=>`
      <img class="assetItem" draggable="true" data-idx="${idx}" src="${src}" alt="asset">
    `).join("");

    document.querySelectorAll(".assetItem").forEach(img=>{
      img.addEventListener("dragstart", (e)=>{
        e.dataTransfer.setData("text/plain", img.src);
      });
    });
  }

  el("addAssets").onclick = ()=> el("assetPicker").click();
  el("assetPicker").onchange = async (e)=>{
    const files = Array.from(e.target.files || []);
    if(!files.length) return;

    const assets = loadAssets();
    for(const f of files){
      const dataUrl = await new Promise((res)=>{
        const r = new FileReader();
        r.onload = ()=>res(String(r.result));
        r.readAsDataURL(f);
      });
      assets.push(dataUrl);
    }
    saveAssets(assets);
    renderAssetTray();
    el("assetPicker").value = "";
  };

  el("clearAssets").onclick = ()=>{
    if(confirm("ç¢ºå®šæ¸…ç©ºè²¼ç´™åº«ï¼Ÿï¼ˆä¸æœƒåˆªä½ å·²è²¼åˆ°æ—¥æœŸä¸Šçš„è£é£¾ï¼‰")){
      saveAssets([]);
      renderAssetTray();
    }
  };

  renderDow();
  renderCalendar();
  renderAssetTray();

  window.addEventListener("focus", async ()=>{
    data = loadData();
    await applyBackground("planner");
    renderCalendar();
  });
</script>
</body>
</html>
