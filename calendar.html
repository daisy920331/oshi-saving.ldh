<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å­˜éŒ¢æœˆæ›†</title>
  <link rel="stylesheet" href="assets/app.css" />
</head>
<body>
  <div class="bg-wrap"></div>

  <header class="topbar">
    <a class="back" href="index.html">â†</a>
    <div class="title">å­˜éŒ¢æœˆæ›†</div>
    <a class="gear" href="settings.html">âš™</a>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="cal-header">
        <button class="btn" id="prev">ä¸Šå€‹æœˆ</button>
        <div class="cal-month" id="monthLabel"></div>
        <button class="btn" id="next">ä¸‹å€‹æœˆ</button>
      </div>

      <div id="dow" class="dow-row"></div>
      <div id="grid" class="grid"></div>
    </div>

    <div class="panel-overlay" id="overlay"></div>
    <div class="panel" id="panel">
      <div class="panel-head">
        <div class="panel-title"><span id="pickedDate"></span></div>
        <button class="btn" id="close">âœ•</button>
      </div>

      <div class="card" style="padding:14px;">
        <h3 style="margin:0 0 8px; font-size:14px;">æ–°å¢ä¸€ç­†å­˜éŒ¢</h3>

        <label>å°è±¡</label>
        <select id="cat"></select>

        <label>äº‹ä»¶</label>
        <select id="event"></select>

        <label>æ¬¡æ•¸</label>
        <input id="times" type="number" min="1" value="1" />

        <div class="row" style="margin-top:10px;align-items:center;">
          <label style="margin:0;display:flex;gap:8px;align-items:center;">
            <input type="checkbox" id="useCustomAmt" />
            ä½¿ç”¨è‡ªè¨‚é‡‘é¡
          </label>
          <input id="customAmt" type="number" min="0" value="0" style="flex:1 1 160px;" disabled />
        </div>

        <button class="btn primary" id="add">â• åŠ å…¥ä»Šå¤©</button>
        <div class="hint">è‡ªè¨‚é‡‘é¡æœƒè¦†è“‹äº‹ä»¶é‡‘é¡Ã—æ¬¡æ•¸ã€‚</div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="clearDecos">ğŸ§¹ æ¸…é™¤ä»Šå¤©è£é£¾</button>
          <button class="btn" id="clearDay"><span style="color:#b42318;">æ¸…ç©ºä»Šå¤©</span></button>
        </div>
      </div>

      <div class="card" style="padding:14px; margin-top:10px;">
        <h3 style="margin:0 0 8px; font-size:14px;">äº‹ä»¶é‡‘é¡è¨­å®š</h3>
        <label>é¸äº‹ä»¶</label>
        <select id="editEvent"></select>
        <label>é‡‘é¡ï¼ˆå…ƒï¼‰</label>
        <input id="editAmount" type="number" min="0" value="0" />
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="saveRule">ğŸ’¾ å„²å­˜é‡‘é¡</button>
          <button class="btn" id="addEvent">âœ¨ æ–°å¢è‡ªè¨‚äº‹ä»¶</button>
        </div>
      </div>

      <div class="card" style="padding:14px; margin-top:10px;">
        <h3 style="margin:0 0 8px; font-size:14px;">ä»Šæ—¥æ˜ç´°</h3>
        <table>
          <thead><tr><th>é¼“å‹µ</th><th>å°è±¡</th><th>äº‹ä»¶</th><th class="right">é‡‘é¡</th></tr></thead>
          <tbody id="log"></tbody>
        </table>
      </div>
    </div>
  </main>

<script type="module">
  import { guardSetup } from "./assets/app.js";
  guardSetup();

  import {
    getCats,
    loadData, saveData, ymd, ymLabel, monthSum,
    pickRewardImage, applyBackground
  } from "./assets/app.js";

  await applyBackground("planner");

  const ASSET_KEY = "oshi_deco_assets_v1";
  const DECO_KEY  = "oshi_calendar_decos_v1"; // {date:[{src,x,y}]}

  const el = id => document.getElementById(id);
  let data = loadData();

  const today = new Date();
  let viewY = today.getFullYear();
  let viewM = today.getMonth();
  let pickedDate = ymd(today);

  function loadAssets(){
    try{ return JSON.parse(localStorage.getItem(ASSET_KEY)||"[]") || []; }
    catch{ return []; }
  }
  function saveAssets(arr){
    localStorage.setItem(ASSET_KEY, JSON.stringify(arr));
  }
  function loadDecos(){
    try{ return JSON.parse(localStorage.getItem(DECO_KEY)||"{}") || {}; }
    catch{ return {}; }
  }
  function saveDecos(obj){
    localStorage.setItem(DECO_KEY, JSON.stringify(obj));
  }

  function catClass(cat){
    if((cat||"").includes("Shokichi")) return "cat-shokichi";
    if((cat||"").includes("Akira")) return "cat-akira";
    return "cat-group";
  }

  function daySum(dateKey){
    const arr = data.records[dateKey] || [];
    return arr.reduce((s,r)=> s + (Number(r.amount)||0), 0);
  }

  function topRecord(dateKey){
    const arr = data.records[dateKey] || [];
    if(!arr.length) return null;
    return arr.reduce((best, r)=>{
      const a = Number(r.amount)||0;
      return !best || a > (Number(best.amount)||0) ? r : best;
    }, null);
  }

  function renderDow(){
    const names = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    el("dow").innerHTML = names.map(n=>`<div class="dow">${n}</div>`).join("");
  }

  // è£é£¾ï¼šé›™æ“Šåˆªé™¤ä¸è§¸ç™¼ cell click
  function renderDecosInCell(cell, dateKey){
    const decos = loadDecos();
    const list = decos[dateKey] || [];
    cell.querySelectorAll(".deco").forEach(x=>x.remove());

    for(const d of list){
      const div = document.createElement("div");
      div.className = "deco";
      div.style.left = (d.x ?? 10) + "px";
      div.style.top  = (d.y ?? 10) + "px";
      div.style.backgroundImage = `url("${d.src}")`;

      div.addEventListener("dblclick", (e)=>{
        e.preventDefault();
        e.stopPropagation();
        const decos2 = loadDecos();
        const arr = decos2[dateKey] || [];
        const idx = arr.findIndex(x => x.src===d.src && x.x===d.x && x.y===d.y);
        if(idx >= 0){
          arr.splice(idx,1);
          if(arr.length) decos2[dateKey] = arr;
          else delete decos2[dateKey];
          saveDecos(decos2);
          render();
          renderDay();
        }
      });

      cell.appendChild(div);
    }
  }

  function stickerInCell(cell, dateKey){
    cell.querySelectorAll(".sticker").forEach(x=>x.remove());
    const tr = topRecord(dateKey);
    if(!tr || !tr.rewardImg) return;

    const s = document.createElement("div");
    s.className = "sticker";
    s.style.backgroundImage = `url("${tr.rewardImg}")`;
    cell.appendChild(s);
  }

  function render(){
    el("monthLabel").textContent = ymLabel(viewY, viewM);

    const first = new Date(viewY, viewM, 1);
    const startDay = first.getDay();
    const daysInMonth = new Date(viewY, viewM+1, 0).getDate();

    const cells = [];
    for(let i=0;i<startDay;i++) cells.push(null);
    for(let d=1; d<=daysInMonth; d++){
      cells.push(new Date(viewY, viewM, d));
    }
    while(cells.length % 7 !== 0) cells.push(null);

    const now = new Date();
    const thisYm = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-`;

    el("grid").innerHTML = "";
    for(const dt of cells){
      const cell = document.createElement("div");
      cell.className = "cell";

      if(!dt){
        cell.classList.add("empty");
        el("grid").appendChild(cell);
        continue;
      }

      const key = ymd(dt);
      const isToday = key === ymd(now);
      if(isToday) cell.classList.add("today");

      const sum = daySum(key);
      if(sum > 0){
        cell.classList.add("has");
      }else{
        cell.classList.add("none");
      }

      const num = document.createElement("div");
      num.className = "num";
      num.textContent = String(dt.getDate());
      cell.appendChild(num);

      const tr = topRecord(key);
      if(tr){
        const tag = document.createElement("div");
        tag.className = `tag ${catClass(tr.cat)}`;
        tag.textContent = (tr.cat || "");
        cell.appendChild(tag);
      }

      const amt = document.createElement("div");
      amt.className = "amt";
      amt.textContent = sum > 0 ? `+${sum}` : "";
      cell.appendChild(amt);

      stickerInCell(cell, key);
      renderDecosInCell(cell, key);

      cell.addEventListener("click", ()=>{
        openDay(key);
      });

      el("grid").appendChild(cell);
    }
  }

  // ======= âœ… å°è±¡ä¸‹æ‹‰ï¼šå³æ™‚è®€è¨­å®š =======
  function renderCats(){
    const cats = getCats();
    el("cat").innerHTML = cats.map(c=>`<option value="${c}">${c}</option>`).join("");
  }
  window.addEventListener("pageshow", ()=>{ renderCats(); });

  function syncAmt(){
    const ev = el("event").value;
    const base = Number(data.rules?.[ev] || 0);
    const t = Number(el("times").value || 1);
    const useCustom = el("useCustomAmt").checked;
    el("customAmt").disabled = !useCustom;
    if(!useCustom){
      el("customAmt").value = String(base * t);
    }
  }

  function syncEditAmount(){
    const ev = el("editEvent").value;
    el("editAmount").value = String(Number(data.rules?.[ev] || 0));
  }

  function fillPanel(){
    renderCats();

    const events = Object.keys(data.rules || {});
    el("event").innerHTML = events.map(e=>`<option value="${e}">${e}</option>`).join("");
    el("editEvent").innerHTML = events.map(e=>`<option value="${e}">${e}</option>`).join("");

    syncAmt();
    syncEditAmount();
  }

  function openDay(dateKey){
    pickedDate = dateKey;
    el("pickedDate").textContent = pickedDate;
    fillPanel();
    renderDay();

    el("overlay").classList.add("show");
    el("panel").classList.add("open");
  }

  function closeDay(){
    el("overlay").classList.remove("show");
    el("panel").classList.remove("open");
  }

  function renderDay(){
    const arr = data.records[pickedDate] || [];
    const tbody = el("log");
    tbody.innerHTML = "";

    for(const r of arr){
      const tr = document.createElement("tr");
      tr.className = catClass(r.cat);

      const tdReward = document.createElement("td");
      tdReward.innerHTML = r.rewardImg ? `<img class="mini" src="${r.rewardImg}">` : "";
      tr.appendChild(tdReward);

      const tdCat = document.createElement("td");
      tdCat.textContent = r.cat || "";
      tr.appendChild(tdCat);

      const tdEvent = document.createElement("td");
      tdEvent.textContent = r.event || "";
      tr.appendChild(tdEvent);

      const tdAmt = document.createElement("td");
      tdAmt.className = "right";
      tdAmt.textContent = String(Number(r.amount)||0);
      tr.appendChild(tdAmt);

      tbody.appendChild(tr);
    }
  }

  // ====== actions ======
  el("prev").onclick = ()=>{ viewM--; if(viewM<0){viewM=11; viewY--;} render(); };
  el("next").onclick = ()=>{ viewM++; if(viewM>11){viewM=0; viewY++;} render(); };
  el("close").onclick = closeDay;
  el("overlay").onclick = closeDay;

  el("times").oninput = syncAmt;
  el("event").onchange = syncAmt;
  el("useCustomAmt").onchange = syncAmt;

  el("add").onclick = async ()=>{
    const cat = el("cat").value;
    const ev  = el("event").value;
    const t   = Math.max(1, Number(el("times").value||1));

    const useCustom = el("useCustomAmt").checked;
    const customAmt = Number(el("customAmt").value||0);

    const base = Number(data.rules?.[ev] || 0);
    const amount = useCustom ? customAmt : (base * t);

    const reward = await pickRewardImage();

    const rec = {
      cat, event: ev, times: t,
      amount: Number(amount)||0,
      rewardImg: reward || "",
      ts: Date.now()
    };

    if(!data.records[pickedDate]) data.records[pickedDate] = [];
    data.records[pickedDate].push(rec);

    // ç•¶å¤©æœ€å¤§é‡‘é¡é‚£ç­† â†’ ä»£è¡¨è²¼ç´™ï¼ˆä½ ä¹‹å‰çš„è¦å‰‡ï¼‰
    saveData(data);
    render();
    renderDay();
  };

  el("clearDay").onclick = ()=>{
    if(!confirm("è¦æ¸…ç©ºä»Šå¤©æ‰€æœ‰å­˜éŒ¢ç´€éŒ„å—ï¼Ÿ")) return;
    delete data.records[pickedDate];
    saveData(data);
    render();
    renderDay();
  };

  el("clearDecos").onclick = ()=>{
    const decos = loadDecos();
    delete decos[pickedDate];
    saveDecos(decos);
    render();
    renderDay();
  };

  el("saveRule").onclick = ()=>{
    const ev = el("editEvent").value;
    const amt = Number(el("editAmount").value||0);
    data.rules[ev] = Math.max(0, amt);
    saveData(data);
    fillPanel();
  };

  el("addEvent").onclick = ()=>{
    const name = prompt("æ–°å¢äº‹ä»¶åç¨±ï¼ˆä¾‹ï¼šæ‰“å¡/ä¸‹å–®/çœ‹åˆ°æ¨æ´»ç…§â€¦ï¼‰");
    if(!name) return;
    if(data.rules[name] != null){
      alert("é€™å€‹äº‹ä»¶å·²å­˜åœ¨");
      return;
    }
    data.rules[name] = 0;
    saveData(data);
    fillPanel();
  };

  // init
  renderDow();
  render();
</script>
</body>
</html>
