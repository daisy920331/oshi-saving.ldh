<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¿½æ˜Ÿå­˜éŒ¢ï½œæœˆæ›†ç‰ˆ</title>
  <link rel="stylesheet" href="assets/app.css" />
  <style>
    .calendar{display:grid; grid-template-columns: repeat(7, 1fr); gap:8px;}
    .dow{color:var(--muted); font-size:12px; padding:0 2px 6px;}
    .cell{
      border:1px solid var(--line); border-radius:14px; background:rgba(18,26,39,.80);
      min-height:92px; padding:10px; cursor:pointer; position:relative;
      transition:.12s transform ease, .12s opacity ease;
    }
    .cell:hover{transform: translateY(-1px); opacity:.96;}
    .date{font-weight:900; font-size:14px;}
    .muted{color:var(--muted); font-size:12px;}
    .sum{margin-top:8px; font-weight:900; font-size:14px;}
    .outside{opacity:.35}

    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:20;}
    .panel{
      position:fixed; right:0; top:0; height:100%; width:min(440px, 100%);
      background:rgba(11,15,23,.92); border-left:1px solid var(--line);
      transform: translateX(100%); transition:.18s transform ease;
      z-index:21; padding:14px; overflow:auto;
      backdrop-filter: blur(10px);
    }
    .panel.open{transform: translateX(0);}
    .overlay.show{display:block;}
    .x{float:right; font-size:18px; padding:6px 10px; border-radius:12px;}

    .reward{
      position:fixed; inset:0; display:none; place-items:center; z-index:30;
      background:rgba(0,0,0,.65);
    }
    .reward.show{display:grid;}
    .rewardBox{
      width:min(520px, 92vw); border:1px solid var(--line); border-radius:16px;
      background:#0b0f17; overflow:hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
    }
    .rewardBox img{width:100%; display:block;}
    .rewardBar{display:flex; justify-content:space-between; align-items:center; padding:10px 12px;}
    .rewardBar b{font-size:13px;}
  </style>
</head>
<body>
  <div class="bg-wrap"></div>

<header>
  <h1>æœˆæ›†ç‰ˆå­˜éŒ¢ï¼ˆæ—¥ç³»æ‰‹å¸³é¢¨ï¼‰</h1>
  <p class="sub"><a href="index.html">â† å›é¦–é </a>ã€€ï½œã€€é»æ—¥æœŸè¨˜éŒ„ï¼ˆè²¼ç´™ï¼ç•¶å¤©æœ€å¤§é‡‘é¡é‚£ç­†ï¼‰</p>
</header>

<main>
  <div class="row" style="margin-bottom:10px;">
    <button class="btn" id="prev">â—€ ä¸Šå€‹æœˆ</button>
    <span class="pill">ç›®å‰æœˆä»½ï¼š<b id="ym"></b></span>
    <button class="btn" id="next">ä¸‹å€‹æœˆ â–¶</button>
    <span class="pill">æœ¬æœˆç´¯è¨ˆï¼š<b id="monthTotal">0</b> å…ƒ</span>
  </div>

  <div class="calendar" id="dow"></div>
  <div class="calendar" id="cal"></div>

  <p class="hint">æç¤ºï¼šå…ˆå» settings è¨­ repoï¼Œä¸¦æŠŠé¼“å‹µåœ–æ”¾åˆ° assets/images/reward/ã€‚</p>
</main>

<div class="overlay" id="overlay"></div>
<div class="panel" id="panel">
  <button class="btn x" id="close">âœ•</button>
  <h2 style="margin:0 0 8px; font-size:15px;">æ¯æ—¥ç´€éŒ„</h2>
  <div class="pill">æ—¥æœŸï¼š<b id="pickedDate"></b></div>

  <div class="card" style="margin-top:10px;">
    <h3 style="margin:0 0 8px; font-size:14px;">æ–°å¢ä¸€ç­†</h3>

    <label>åˆ†é¡</label>
    <select id="cat"></select>

    <label>äº‹ä»¶</label>
    <select id="event"></select>

    <div class="row">
      <div style="flex:1 1 140px;">
        <label>æ¬¡æ•¸</label>
        <input id="times" type="number" min="1" value="1" />
      </div>
      <div style="flex:1 1 180px;">
        <label>æœ¬æ¬¡é‡‘é¡ï¼ˆè‡ªå‹•ï¼‰</label>
        <input id="amt" type="number" disabled />
      </div>
    </div>

    <button class="btn good" id="add">â• åŠ å…¥ä»Šå¤©</button>
    <div class="hint">é‡‘é¡æ²’æƒ³å¥½å¯ä»¥å…ˆè¨­ 0ï¼Œä¹‹å¾Œå†èª¿æ•´ã€‚</div>
  </div>

  <div class="card" style="margin-top:10px;">
    <h3 style="margin:0; font-size:14px;">ä»Šå¤©ç´¯è¨ˆï¼š<span id="dayTotal">0</span> å…ƒ</h3>
    <table>
      <thead><tr><th>é¼“å‹µ</th><th>åˆ†é¡</th><th>äº‹ä»¶</th><th class="right">é‡‘é¡</th></tr></thead>
      <tbody id="log"></tbody>
    </table>
    <button class="btn bad" id="clearDay" style="margin-top:10px;">æ¸…ç©ºä»Šå¤©</button>
  </div>

  <div class="card" style="margin-top:10px;">
    <h3 style="margin:0 0 8px; font-size:14px;">äº‹ä»¶é‡‘é¡è¨­å®šï¼ˆå…¨ç«™å…±ç”¨ï¼‰</h3>
    <label>é¸äº‹ä»¶</label>
    <select id="editEvent"></select>
    <label>é‡‘é¡ï¼ˆå…ƒï¼‰</label>
    <input id="editAmount" type="number" min="0" value="0" />
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="saveRule">ğŸ’¾ å„²å­˜é‡‘é¡</button>
      <button class="btn" id="addEvent">âœ¨ æ–°å¢è‡ªè¨‚äº‹ä»¶</button>
    </div>
  </div>
</div>

<div class="reward" id="reward">
  <div class="rewardBox">
    <img id="rewardImg" alt="reward">
    <div class="rewardBar">
      <b id="rewardText">ä½ åšå¾—å¾ˆå¥½ï¼</b>
      <button class="btn" id="rewardClose">æ”¶ä¸‹é¼“å‹µ</button>
    </div>
  </div>
</div>

<script type="module">
  import {
    CATS, loadData, saveData, ymd, ymLabel, monthSum, daySum,
    pickRewardImage, daySticker, applyBackground
  } from "./assets/app.js";

  await applyBackground("planner");

  const el = id => document.getElementById(id);

  let data = loadData();
  const today = new Date();
  let viewY = today.getFullYear();
  let viewM = today.getMonth();
  let pickedDate = ymd(today);

  function renderDow(){
    const names = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    el("dow").innerHTML = names.map(n=>`<div class="dow">${n}</div>`).join("");
  }

  function renderCalendar(){
    el("ym").textContent = ymLabel(viewY, viewM);
    el("monthTotal").textContent = String(monthSum(data, viewY, viewM, ""));

    const first = new Date(viewY, viewM, 1);
    const startDay = first.getDay();
    const start = new Date(viewY, viewM, 1 - startDay);

    const cells = [];
    for(let i=0;i<42;i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      const key = ymd(d);
      const outside = d.getMonth() !== viewM;
      const sum = daySum(data, key, "");
      const has = sum > 0;

      const sticker = has ? daySticker(data, key, "") : "";

      cells.push(`
        <div class="cell ${outside ? "outside":""}" data-date="${key}">
          <div class="date">${d.getDate()}</div>
          <div class="muted">${has ? "å·²å­˜éŒ¢" : "å°šæœª"}</div>
          <div class="sum">${sum} å…ƒ</div>
          ${sticker ? `<div class="sticker" style="background-image:url('${sticker}')"></div>` : ""}
        </div>
      `);
    }
    el("cal").innerHTML = cells.join("");
    document.querySelectorAll(".cell").forEach(c=>{
      c.addEventListener("click", ()=>openDay(c.dataset.date));
    });
  }

  function fillPanel(){
    el("cat").innerHTML = CATS.map(c=>`<option value="${c}">${c}</option>`).join("");
    const events = Object.keys(data.rules);
    el("event").innerHTML = events.map(e=>`<option value="${e}">${e}</option>`).join("");
    el("editEvent").innerHTML = events.map(e=>`<option value="${e}">${e}</option>`).join("");
    syncAmt();
    syncEditAmount();
  }

  function syncAmt(){
    const e = el("event").value;
    const times = Math.max(1, Number(el("times").value || 1));
    const unit = Number(data.rules[e] || 0);
    el("amt").value = unit * times;
  }
  function syncEditAmount(){
    const e = el("editEvent").value;
    el("editAmount").value = Number(data.rules[e] || 0);
  }

  function renderDay(){
    el("pickedDate").textContent = pickedDate;
    const arr = data.records[pickedDate] || [];
    el("dayTotal").textContent = String(daySum(data, pickedDate, ""));

    const rows = arr.slice().reverse().map(x=>`
      <tr>
        <td>${x.rewardImg ? `<img class="thumb" src="${x.rewardImg}" alt="reward">` : ""}</td>
        <td>${x.cat}</td>
        <td>${x.event}${x.times>1 ? ` Ã—${x.times}`:""}</td>
        <td class="right">${x.amount}</td>
      </tr>
    `).join("");

    el("log").innerHTML = rows || `<tr><td colspan="4" style="color:var(--muted); padding:14px;">ä»Šå¤©é‚„æ²’æœ‰ç´€éŒ„</td></tr>`;
  }

  function openDay(dateKey){
    pickedDate = dateKey;
    el("overlay").classList.add("show");
    el("panel").classList.add("open");
    fillPanel();
    renderDay();
  }
  function closeDay(){
    el("overlay").classList.remove("show");
    el("panel").classList.remove("open");
  }

  function showReward(amount, rewardImg){
    if(!rewardImg) return;
    el("rewardImg").src = rewardImg;
    el("rewardText").textContent = `å­˜å…¥ ${amount} å…ƒï¼ä½ è¶…æ£’ï¼`;
    el("reward").classList.add("show");
  }
  function closeReward(){
    el("reward").classList.remove("show");
  }

  el("times").addEventListener("input", ()=>{ if(Number(el("times").value)<1) el("times").value=1; syncAmt(); });
  el("event").addEventListener("change", syncAmt);
  el("editEvent").addEventListener("change", syncEditAmount);

  el("add").addEventListener("click", async ()=>{
    const cat = el("cat").value;
    const event = el("event").value;
    const times = Math.max(1, Number(el("times").value||1));
    const unit = Number(data.rules[event]||0);
    const amount = unit * times;

    const rewardImg = await pickRewardImage(); // âœ…é ç«¯æ¸…å–®éš¨æ©Ÿé¼“å‹µåœ–

    if(!data.records[pickedDate]) data.records[pickedDate] = [];
    data.records[pickedDate].push({ cat, event, times, amount, rewardImg, ts: Date.now() });

    saveData(data);
    renderDay();
    renderCalendar();
    showReward(amount, rewardImg);
  });

  el("clearDay").addEventListener("click", ()=>{
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºä»Šå¤©å…¨éƒ¨ç´€éŒ„ï¼Ÿ")){
      delete data.records[pickedDate];
      saveData(data);
      renderDay();
      renderCalendar();
    }
  });

  el("saveRule").addEventListener("click", ()=>{
    const e = el("editEvent").value;
    const amt = Math.max(0, Number(el("editAmount").value||0));
    data.rules[e] = amt;
    saveData(data);
    syncAmt();
    alert("å·²å„²å­˜é‡‘é¡ï¼");
  });

  el("addEvent").addEventListener("click", ()=>{
    const name = prompt("è¼¸å…¥æ–°äº‹ä»¶åç¨±ï¼š");
    if(!name) return;
    const k = name.trim();
    if(!k) return;
    if(Object.prototype.hasOwnProperty.call(data.rules, k)){
      alert("äº‹ä»¶å·²å­˜åœ¨ï¼");
      return;
    }
    data.rules[k] = 0;
    saveData(data);
    fillPanel();
    alert("å·²æ–°å¢äº‹ä»¶ï¼ˆé‡‘é¡å…ˆè¨­ 0ï¼‰");
  });

  el("prev").addEventListener("click", ()=>{
    viewM -= 1;
    if(viewM<0){ viewM=11; viewY-=1; }
    renderCalendar();
  });
  el("next").addEventListener("click", ()=>{
    viewM += 1;
    if(viewM>11){ viewM=0; viewY+=1; }
    renderCalendar();
  });

  el("overlay").addEventListener("click", closeDay);
  el("close").addEventListener("click", closeDay);

  el("rewardClose").addEventListener("click", closeReward);
  el("reward").addEventListener("click", (e)=>{ if(e.target.id==="reward") closeReward(); });

  renderDow();
  renderCalendar();

  window.addEventListener("focus", async ()=>{
    data = loadData();
    await applyBackground("planner");
    renderCalendar();
  });
</script>
</body>
</html>
