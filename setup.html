<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>首次設定｜LDH追星存錢手帳</title>
  <link rel="stylesheet" href="assets/app.css"/>
  <style>
    .wrap{max-width:920px;margin:0 auto;padding:20px 16px 44px;}
    .paper{border:1px solid var(--line);border-radius:22px;background:rgba(255,255,255,.92);box-shadow:0 18px 34px rgba(0,0,0,.10), 0 2px 0 rgba(0,0,0,.03);padding:18px;position:relative;overflow:hidden;}
    .paper::after{content:"";position:absolute;top:-10px;right:18px;width:110px;height:34px;background:rgba(180,150,90,.25);border:1px solid rgba(180,150,90,.30);border-radius:10px;transform:rotate(7deg);box-shadow:0 10px 18px rgba(0,0,0,.10);-webkit-mask-image:linear-gradient(90deg,rgba(0,0,0,0) 0%,rgba(0,0,0,1) 12%,rgba(0,0,0,1) 88%,rgba(0,0,0,0) 100%);mask-image:linear-gradient(90deg,rgba(0,0,0,0) 0%,rgba(0,0,0,1) 12%,rgba(0,0,0,1) 88%,rgba(0,0,0,0) 100%);opacity:.95;pointer-events:none;}
    h1{margin:0 0 10px;font-size:20px;}
    .hint{color:var(--muted);font-size:12px;margin-top:6px;}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr;}}
    .card2{border:1px solid var(--line);border-radius:18px;background:#fff;padding:14px;}
    .row2{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .catList{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
    .catItem{border:1px solid var(--line);border-radius:16px;background:rgba(250,249,246,.92);padding:12px;}
    .catHead{display:flex;justify-content:space-between;gap:10px;align-items:center;}
    .mini{font-size:12px;color:var(--muted);}
    .previewTag{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid transparent;font-weight:900;font-size:12px;margin-top:10px;width:fit-content;}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}

    .poolBox{border:1px dashed rgba(120,120,120,.35);border-radius:16px;padding:12px;background:rgba(250,249,246,.7);margin-top:12px;}
    .tabRow{display:flex;gap:8px;flex-wrap:wrap;}
    .tabBtn{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:900;cursor:pointer;}
    .tabBtn.on{background:rgba(180,150,90,.16);}
    .poolList{max-height:260px;overflow:auto;margin-top:10px;display:flex;flex-direction:column;gap:6px;}
    .poolItem{display:flex;align-items:center;gap:10px;border:1px solid rgba(0,0,0,.06);background:#fff;border-radius:14px;padding:8px 10px;}
    .poolItem small{color:var(--muted);}
    .poolActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center;justify-content:space-between;}
    .modePill{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-weight:900;font-size:12px;}
  </style>
</head>
<body>
  <div class="bg-wrap"></div>

<header>
  <h1>首次設定</h1>
  <div class="sub">只會在第一次使用前跳出；之後可在「設定」更改。</div>
</header>

<div class="wrap">
  <div class="paper">
    <div class="grid">

      <div class="card2">
        <h2 style="margin:0 0 10px;font-size:15px;">① 手帳名稱</h2>
        <label>你的名字（可不填）</label>
        <input id="ownerName" type="text" placeholder="例：小美" />
        <div class="hint">不填也可以，名稱會用「LDH追星存錢手帳」。</div>

        <label style="margin-top:10px;">自訂手帳名稱（可留空）</label>
        <input id="siteTitle" type="text" placeholder="例：小美的LDH追星存錢手帳" />
        <div class="hint">若留空，會自動用「你的名字＋的LDH追星存錢手帳」。</div>

        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0;">

        <h2 style="margin:0 0 10px;font-size:15px;">② 存款對象與顏色</h2>

        <div class="poolBox">
          <b>從名單加入（可勾選多個）</b>
          <div class="hint">切換「團體 / 個人」，再選擇顯示方式（完整/簡稱；英文/漢字）。</div>

          <div class="tabRow" style="margin-top:10px;">
            <button class="tabBtn on" id="tabGroups">團體</button>
            <button class="tabBtn" id="tabPeople">個人</button>
          </div>

          <!-- 顯示方式切換 -->
          <div class="modePill" id="modeWrap">
            <label class="pill" id="groupModePill">
              團體顯示：
              <select id="groupNameMode">
                <option value="full">完整名</option>
                <option value="short">簡稱（若有）</option>
              </select>
            </label>

            <label class="pill" id="peopleModePill" style="display:none;">
              個人顯示：
              <select id="peopleNameMode">
                <option value="roman">英文字名</option>
                <option value="kanji">漢字名（若有）</option>
              </select>
            </label>
          </div>

          <div class="row2" style="margin-top:10px;">
            <input id="poolSearch" type="text" placeholder="搜尋…" style="flex:1 1 240px;">
            <button class="btn" id="poolCheckAll">全選</button>
            <button class="btn" id="poolUncheckAll">全不選</button>
          </div>

          <div class="poolList" id="poolList"></div>

          <div class="poolActions">
            <small class="mini" id="poolCount">已選 0</small>
            <button class="btn" id="poolAddSelected">＋加入已選</button>
          </div>
        </div>

        <div class="row2" style="margin-top:12px;">
          <input id="newCat" type="text" placeholder="手動新增對象" style="flex:1 1 240px;">
          <button class="btn" id="addCat">＋新增</button>
        </div>

        <div class="catList" id="catList"></div>
        <div class="hint">顏色會套用到：月曆標籤、事件頁膠帶與標籤。</div>
      </div>

      <div class="card2">
        <h2 style="margin:0 0 10px;font-size:15px;">③ 初始背景</h2>
        <label>選擇背景</label>
        <select id="bgSelect"></select>

        <label style="margin-top:10px;">或上傳自己的背景</label>
        <input id="bgUpload" type="file" accept="image/*"/>
        <div class="hint">上傳會存進瀏覽器（localStorage）。清除瀏覽資料會消失。</div>

        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0;">
        <div class="btnRow">
          <button class="btn primary" id="save">✅ 儲存並開始使用</button>
          <button class="btn" id="reset">重設為預設值</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script type="module">
  import {
    DEFAULT_CATS, getBuiltInBackgrounds,
    getConfig, saveConfig, applyBackground, getCatTheme
  } from "./assets/app.js";
  import { PRESET_GROUPS, PRESET_PEOPLE } from "./assets/presets.js";

  await applyBackground("planner");
  const el = (id)=>document.getElementById(id);

  const cfg = getConfig() || {
    setupDone: false,
    ownerName: "",
    siteTitle: "",
    cats: DEFAULT_CATS.slice(),
    themeMap: {},
    backgroundUrl: "",
    musicDataUrl: "",
  };

  el("ownerName").value = cfg.ownerName || "";
  el("siteTitle").value = cfg.siteTitle || "";

  // 背景
  const bgs = getBuiltInBackgrounds().filter(Boolean);
  el("bgSelect").innerHTML = bgs.map(u=>`<option value="${u}">${u}</option>`).join("");
  el("bgSelect").value = (cfg.backgroundUrl && bgs.includes(cfg.backgroundUrl)) ? cfg.backgroundUrl : (bgs[0] || "assets/backgrounds/default.jpg");

  // ===== 候選池 =====
  let poolMode = "groups"; // groups | people

  function getDisplayNameFromGroup(g){
    const mode = el("groupNameMode").value; // full | short
    if(mode === "short" && g.short) return g.short;
    return g.full;
  }
  function getDisplayNameFromPerson(p){
    const mode = el("peopleNameMode").value; // roman | kanji
    if(mode === "kanji" && p.kanji) return p.kanji;
    return p.roman;
  }

  function poolItems(){
    const q = (el("poolSearch").value || "").trim().toLowerCase();
    let list = [];
    if(poolMode === "groups"){
      list = PRESET_GROUPS.map(g=>({
        key: g.full, // 穩定 key（避免切換顯示方式造成勾選混亂）
        text: getDisplayNameFromGroup(g),
        meta: g.short ? `可用簡稱：${g.short}` : "團體",
      }));
    }else{
      list = PRESET_PEOPLE.map(p=>({
        key: p.roman + (p.kanji ? `|${p.kanji}` : ""),
        text: getDisplayNameFromPerson(p),
        meta: p.kanji ? `可切換：${p.roman} / ${p.kanji}` : "個人",
      }));
    }
    if(!q) return list;
    return list.filter(x => (x.text + " " + x.meta).toLowerCase().includes(q));
  }

  function renderPool(){
    const list = poolItems();
    el("poolList").innerHTML = list.map(x=>`
      <label class="poolItem">
        <input type="checkbox" data-key="${escapeHtml(x.key)}" data-text="${escapeHtml(x.text)}">
        <div style="display:flex;flex-direction:column;gap:2px;">
          <b>${escapeHtml(x.text)}</b>
          <small>${escapeHtml(x.meta)}</small>
        </div>
      </label>
    `).join("");

    updatePoolCount();
    el("poolList").querySelectorAll("input[type=checkbox]").forEach(cb=>{
      cb.onchange = updatePoolCount;
    });
  }

  function updatePoolCount(){
    const n = el("poolList").querySelectorAll("input[type=checkbox]:checked").length;
    el("poolCount").textContent = `已選 ${n}`;
  }

  function setMode(mode){
    poolMode = mode;
    if(mode === "groups"){
      el("tabGroups").classList.add("on"); el("tabPeople").classList.remove("on");
      el("groupModePill").style.display = "";
      el("peopleModePill").style.display = "none";
    }else{
      el("tabPeople").classList.add("on"); el("tabGroups").classList.remove("on");
      el("groupModePill").style.display = "none";
      el("peopleModePill").style.display = "";
    }
    el("poolSearch").value = "";
    renderPool();
  }

  el("tabGroups").onclick = ()=>setMode("groups");
  el("tabPeople").onclick = ()=>setMode("people");
  el("poolSearch").oninput = renderPool;
  el("groupNameMode").onchange = renderPool;
  el("peopleNameMode").onchange = renderPool;

  el("poolCheckAll").onclick = ()=>{
    el("poolList").querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked = true);
    updatePoolCount();
  };
  el("poolUncheckAll").onclick = ()=>{
    el("poolList").querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked = false);
    updatePoolCount();
  };

  el("poolAddSelected").onclick = ()=>{
    const picked = Array.from(el("poolList").querySelectorAll("input[type=checkbox]:checked"))
      .map(cb => cb.getAttribute("data-text"))
      .filter(Boolean);

    if(!picked.length) return;

    let added = 0;
    for(const name of picked){
      if(cfg.cats.includes(name)) continue;
      cfg.cats.push(name);
      added += 1;
    }
    renderCats();
    alert(added ? `已加入 ${added} 個對象！` : "選到的對象都已經存在了～");
  };

  // ===== 已選對象＋顏色 =====
  function renderCats(){
    const list = el("catList");
    list.innerHTML = "";

    cfg.cats.forEach((name, idx)=>{
      const t = cfg.themeMap[name] || getCatTheme(name);

      const div = document.createElement("div");
      div.className = "catItem";
      div.innerHTML = `
        <div class="catHead">
          <b>${escapeHtml(name)}</b>
          <button class="btn" data-del="${idx}"><span style="color:#b42318">刪除</span></button>
        </div>

        <div class="row2" style="margin-top:10px;">
          <div style="flex:1 1 150px;">
            <label>底色</label>
            <input type="color" data-k="bg" data-i="${idx}" value="${toHex(t.bg) || "#f1f1f1"}"/>
          </div>
          <div style="flex:1 1 150px;">
            <label>字色</label>
            <input type="color" data-k="fg" data-i="${idx}" value="${toHex(t.fg) || "#111111"}"/>
          </div>
          <div style="flex:1 1 150px;">
            <label>邊框</label>
            <input type="color" data-k="border" data-i="${idx}" value="${toHex(t.border) || "#cccccc"}"/>
          </div>
          <div style="flex:1 1 150px;">
            <label>膠帶</label>
            <input type="color" data-k="tape" data-i="${idx}" value="${toHex(t.tape) || "#cccccc"}"/>
          </div>
        </div>

        <div class="previewTag" style="background:${t.bg};color:${t.fg};border:1px solid ${t.border};">
          預覽：${escapeHtml(name)}
        </div>
      `;
      list.appendChild(div);
    });

    list.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-del"));
        const name = cfg.cats[i];
        if(!confirm(`確定刪除「${name}」？`)) return;
        cfg.cats.splice(i,1);
        delete cfg.themeMap[name];
        renderCats();
      };
    });

    list.querySelectorAll("input[type=color]").forEach(inp=>{
      inp.oninput = ()=>{
        const i = Number(inp.getAttribute("data-i"));
        const k = inp.getAttribute("data-k");
        const name = cfg.cats[i];
        if(!cfg.themeMap[name]) cfg.themeMap[name] = { bg:"", fg:"", border:"", tape:"" };
        cfg.themeMap[name][k] = inp.value;
        renderCats();
      };
    });
  }

  // 手動新增
  el("addCat").onclick = ()=>{
    const v = (el("newCat").value || "").trim();
    if(!v) return;
    if(cfg.cats.includes(v)) return alert("這個對象已存在！");
    cfg.cats.push(v);
    el("newCat").value = "";
    renderCats();
  };

  // 背景
  el("bgUpload").onchange = async (e)=>{
    const f = (e.target.files || [])[0];
    if(!f) return;
    const dataUrl = await new Promise(res=>{
      const r = new FileReader();
      r.onload = ()=>res(String(r.result));
      r.readAsDataURL(f);
    });
    cfg.backgroundUrl = dataUrl;
    await applyBackground("planner");
    alert("已上傳背景！記得按『儲存並開始使用』");
  };
  el("bgSelect").onchange = async ()=>{
    cfg.backgroundUrl = el("bgSelect").value;
    await applyBackground("planner");
  };

  // 儲存
  el("save").onclick = ()=>{
    cfg.ownerName = (el("ownerName").value || "").trim();
    cfg.siteTitle = (el("siteTitle").value || "").trim();
    cfg.setupDone = true;
    saveConfig(cfg);
    location.href = "index.html";
  };

  // 重設
  el("reset").onclick = async ()=>{
    if(!confirm("確定重設為預設值？")) return;
    cfg.setupDone = false;
    cfg.ownerName = "";
    cfg.siteTitle = "";
    cfg.cats = DEFAULT_CATS.slice();
    cfg.themeMap = {};
    cfg.backgroundUrl = "assets/backgrounds/default.jpg";
    renderCats();
    await applyBackground("planner");
    el("ownerName").value = "";
    el("siteTitle").value = "";
    el("bgSelect").value = "assets/backgrounds/default.jpg";
    el("bgUpload").value = "";
  };

  function toHex(x){
    if(!x) return "";
    const s = String(x).trim();
    if(s.startsWith("#")) return s.length===4 ? expand3(s) : s;
    return "";
  }
  function expand3(h){ return "#" + h[1]+h[1]+h[2]+h[2]+h[3]+h[3]; }
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // init
  setMode("groups");
  renderCats();
</script>
</body>
</html>
