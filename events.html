<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>事件統整</title>
  <link rel="stylesheet" href="assets/app.css" />
  <style>
    .wrap{max-width:960px;margin:0 auto;padding:24px 16px 40px;}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap;}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}

    .seg{
      display:flex; gap:6px; padding:6px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      border-radius:999px;
    }
    .seg button{
      border:1px solid transparent;
      background:transparent;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      color:var(--muted);
    }
    .seg button.active{
      background:#fff;
      border-color:var(--line);
      color:var(--ink);
      box-shadow:0 10px 22px rgba(0,0,0,.08), 0 2px 0 rgba(0,0,0,.03);
      font-weight:800;
    }

    .kpis{display:flex;gap:10px;flex-wrap:wrap;}
    .pill-tight{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#faf9f6;
      font-size:12px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (min-width:880px){
      .grid{grid-template-columns: 1fr 1fr;}
    }

    .eventCard{
      position:relative;
      border:1px solid var(--line);
      border-radius:20px;
      background:rgba(255,255,255,.88);
      padding:16px;
      cursor:pointer;
      transition:.12s transform ease, .12s opacity ease;
      overflow:hidden;
      box-shadow:0 10px 22px rgba(0,0,0,.08), 0 2px 0 rgba(0,0,0,.03);
    }
    .eventCard:hover{transform:translateY(-1px);opacity:.97}

    /* ===== 膠帶（會依分類變色） ===== */
    .eventCard::after{
      content:"";
      position:absolute;
      top:-10px;
      right:14px;
      width:86px;
      height:30px;
      transform: rotate(7deg);
      border-radius: 8px;
      opacity:.95;
      pointer-events:none;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      -webkit-mask-image: linear-gradient(90deg,
        rgba(0,0,0,0) 0%,
        rgba(0,0,0,1) 12%,
        rgba(0,0,0,1) 88%,
        rgba(0,0,0,0) 100%);
      mask-image: linear-gradient(90deg,
        rgba(0,0,0,0) 0%,
        rgba(0,0,0,1) 12%,
        rgba(0,0,0,1) 88%,
        rgba(0,0,0,0) 100%);
    }

    /* Shokichi：橘紅膠帶 */
    .tape-shokichi::after{
      background: rgba(226, 88, 34, .35);
      border:1px solid rgba(226, 88, 34, .45);
    }

    /* Akira：黑金膠帶 */
    .tape-akira::after{
      background: rgba(40, 40, 40, .30);
      border:1px solid rgba(180, 150, 90, .65);
    }

    /* 團體：森林綠膠帶 */
    .tape-group::after{
      background: rgba(34, 139, 34, .32);
      border:1px solid rgba(34, 139, 34, .45);
    }

    .eventTitle{font-weight:900;font-size:15px;margin:8px 0 0;}
    .eventMeta{margin-top:6px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap;}
    .eventSum{margin-top:10px;font-weight:900;font-size:16px;}

    /* 三色標籤 */
    .tag{
      display:inline-flex;
      align-items:center;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid transparent;
      background:#faf9f6;
    }
    .cat-shokichi{
      background: rgba(226, 88, 34, .14);
      color: #c2410c;
      border-color: rgba(226, 88, 34, .35);
    }
    .cat-akira{
      background: rgba(32, 32, 32, .08);
      color: #1f1f1f;
      border-color: rgba(180, 150, 90, .55);
      box-shadow: inset 0 0 0 1px rgba(180,150,90,.25);
    }
    .cat-group{
      background: rgba(34, 139, 34, .14);
      color: #166534;
      border-color: rgba(34, 139, 34, .35);
    }

    /* 明細便條紙 */
    .dayBlock{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(250, 249, 246, .92);
      padding:12px;
      margin-top:10px;
      box-shadow:0 10px 22px rgba(0,0,0,.06), 0 2px 0 rgba(0,0,0,.02);
    }
    .dayHead{display:flex;justify-content:space-between;cursor:pointer;}
    .chev{font-size:12px;color:var(--muted);}
    .dayBody{display:none;margin-top:10px;}
    .dayBody.open{display:block;}

    .thumb{
      width:44px;height:44px;
      border-radius:12px;
      border:1px solid var(--line);
      object-fit:cover;
      background:#faf9f6;
    }
  </style>
</head>
<body>
<div class="bg-wrap"></div>

<header>
  <h1>事件統整</h1>
  <div class="sub"><a href="index.html">← 回首頁</a></div>
</header>

<div class="wrap">
  <div class="topbar">
    <div class="filters">
      <div class="seg">
        <button class="active" data-cat="">全部</button>
        <button data-cat="Shokichi">Shokichi</button>
        <button data-cat="Akira">Akira</button>
        <button data-cat="GROUP">團體</button>
      </div>
    </div>
    <div class="kpis">
      <span class="pill-tight">事件數：<b id="eventCount">0</b></span>
      <span class="pill-tight">合計：<b id="eventTotal">0</b> 元</span>
    </div>
  </div>

  <div class="grid" id="grid"></div>
</div>

<script type="module">
import { loadData, applyBackground } from "./assets/app.js";
await applyBackground("planner");

const el = id=>document.getElementById(id);
let data = loadData();
let activeCat = "";

function catClass(cat){
  if((cat||"").includes("Shokichi")) return "cat-shokichi tape-shokichi";
  if((cat||"").includes("Akira")) return "cat-akira tape-akira";
  return "cat-group tape-group";
}

function matchesFilter(r){
  if(!activeCat) return true;
  if(activeCat==="GROUP") return !(r.cat.includes("Shokichi")||r.cat.includes("Akira"));
  return r.cat.includes(activeCat);
}

function render(){
  const map = new Map();
  for(const [date, arr] of Object.entries(data.records||{})){
    for(const r of arr){
      if(!matchesFilter(r)) continue;
      if(!map.has(r.event)) map.set(r.event,{total:0,days:{}});
      map.get(r.event).total+=r.amount;
      (map.get(r.event).days[date]??=[]).push(r);
    }
  }

  const list=[...map.entries()].map(([event,obj])=>({event,...obj}))
    .sort((a,b)=>b.total-a.total);

  el("eventCount").textContent=list.length;
  el("eventTotal").textContent=list.reduce((s,x)=>s+x.total,0);

  el("grid").innerHTML=list.map(item=>{
    let top=null;
    Object.values(item.days).forEach(ds=>ds.forEach(r=>{
      if(!top||r.amount>top.amount) top=r;
    }));
    return `
      <div class="eventCard ${catClass(top?.cat||"")}">
        <div class="tag ${catClass(top?.cat||"")}">${top?.cat||""}</div>
        <h3 class="eventTitle">${item.event}</h3>
        <div class="eventMeta">
          <span>出現天數：${Object.keys(item.days).length}</span>
          <span>合計</span>
        </div>
        <div class="eventSum">${item.total} 元</div>
      </div>
    `;
  }).join("");
}

document.querySelectorAll(".seg button").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".seg button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    activeCat=b.dataset.cat||"";
    render();
  };
});

render();
</script>
</body>
</html>
