<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¿½æ˜Ÿå­˜éŒ¢æ‰‹å¸³</title>
  <link rel="stylesheet" href="assets/app.css" />
  <style>
    /* ä¸‰å¤§å…¥å£ï¼šæ‰‹æ©Ÿè‡ªå‹•è®Š 1 æ¬„ï¼Œé›»è…¦ 3 æ¬„ */
    .home-actions{
      display:grid;
      grid-template-columns: 1fr;
      gap:18px;
      width:100%;
      max-width:860px;
    }
    @media (min-width:820px){
      .home-actions{ grid-template-columns: 1fr 1fr 1fr; }
    }
    .home-actions .btn.primary{
      height:150px;
      padding:24px;
    }
    .home-actions .icon{font-size:40px;}
    .home-actions .desc{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      font-weight:500;
      letter-spacing:0;
    }
  </style>
</head>
<body>
  <div class="bg-wrap"></div>

<header>
  <h1>è¿½æ˜Ÿå­˜éŒ¢æ‰‹å¸³</h1>

  <!-- å³ä¸Šè§’å°å°ç´ æåº« -->
  <a class="mini-link" href="settings.html">ç´ æåº«</a>
</header>

<main class="home-main">
  <!-- KPI -->
  <div class="row">
    <span class="pill">æœ¬æœˆå­˜å…¥ï¼š<b id="monthSave">0</b></span>
    <span class="pill">æœ¬æœˆèŠ±è²»ï¼š<b id="monthSpend">0</b></span>
    <span class="pill">é€£çºŒæ‰“å¡ï¼š<b id="streak">0</b> å¤©</span>
  </div>

  <!-- ä¸‰å€‹å¤§å…¥å£ -->
  <div class="home-actions">
    <a class="btn primary" href="calendar.html">
      <div class="icon">ğŸ“…</div>
      <div>æœˆæ›†å­˜éŒ¢</div>
      <div class="desc">é»æ—¥æœŸè¨˜éŒ„å­˜å…¥ï¼Œè²¼ç´™ï¼ç•¶å¤©æœ€å¤§é‡‘é¡</div>
    </a>

    <a class="btn primary" href="events.html">
      <div class="icon">ğŸ“Š</div>
      <div>äº‹ä»¶çµ±æ•´</div>
      <div class="desc">æŒ‰åˆ†é¡åˆ‡æ›ï¼Œé»äº‹ä»¶çœ‹æ¯æ—¥èˆ‡æ˜ç´°</div>
    </a>

    <a class="btn primary" href="expense.html">
      <div class="icon">ğŸ§¾</div>
      <div>èŠ±è²»æ—¥æ›†</div>
      <div class="desc">é»æ—¥æœŸè¨˜éŒ„æ”¯å‡ºï¼Œæœ¬æœˆåˆè¨ˆä¸€çœ¼çœ‹æ‡‚</div>
    </a>
  </div>

  <!-- æœ€ä¸‹é¢ï¼šå¤–è§€èˆ‡éŸ³æ¨‚ï¼ˆå°å°çš„ï¼‰ -->
  <div class="home-footer">
    <div class="row">
      <button class="btn" id="bgPrev">èƒŒæ™¯ â—€</button>
      <button class="btn" id="bgNext">èƒŒæ™¯ â–¶</button>

      <span>é€æ˜åº¦</span>
      <input id="bgOpacity" type="range" min="0.1" max="0.6" step="0.05" />

      <button class="btn" id="musicToggle">ğŸµ éŸ³æ¨‚</button>
    </div>

    <audio id="bgm" style="width:100%;margin-top:8px;display:none" controls></audio>
  </div>
</main>

<script type="module">
  import {
    getUI, saveUI, applyBackground, setupBGM,
    loadData, monthSum, computeStreak, ymd, pad
  } from "./assets/app.js";

  // èŠ±è²»è³‡æ–™ keyï¼ˆè·Ÿ expense.html ä¸€è‡´ï¼‰
  const EXP_KEY = "oshi_expenses_v1";
  function loadExpenses(){
    const raw = localStorage.getItem(EXP_KEY);
    if(!raw) return { records:{} };
    try{
      const x = JSON.parse(raw);
      return x && x.records ? x : { records:{} };
    }catch{
      return { records:{} };
    }
  }
  function expenseMonthSum(exp, y, m){
    const prefix = `${y}-${pad(m+1)}-`;
    let s = 0;
    for(const k of Object.keys(exp.records)){
      if(!k.startsWith(prefix)) continue;
      const arr = exp.records[k] || [];
      s += arr.reduce((t,r)=>t + (Number(r.amount)||0), 0);
    }
    return s;
  }

  const bgOpacity = document.getElementById("bgOpacity");
  const musicToggle = document.getElementById("musicToggle");
  const audio = document.getElementById("bgm");

  function syncKPI(){
    const now = new Date();
    const todayKey = ymd(now);

    // å­˜éŒ¢ KPI
    const saveDataObj = loadData();
    document.getElementById("monthSave").textContent =
      String(monthSum(saveDataObj, now.getFullYear(), now.getMonth(), ""));
    document.getElementById("streak").textContent =
      String(computeStreak(saveDataObj, todayKey, ""));

    // èŠ±è²» KPI
    const exp = loadExpenses();
    document.getElementById("monthSpend").textContent =
      String(expenseMonthSum(exp, now.getFullYear(), now.getMonth()));
  }

  async function syncUI(){
    const ui = getUI();
    await applyBackground("home");
    bgOpacity.value = String(ui.bgOpacity ?? 0.25);
    musicToggle.textContent = ui.musicOn ? "ğŸµ éŸ³æ¨‚ ON" : "ğŸµ éŸ³æ¨‚ OFF";
    audio.style.display = ui.musicOn ? "block" : "none";
    await setupBGM(audio);
  }

  document.getElementById("bgPrev").onclick = async ()=>{
    const ui = getUI(); ui.bgIndexHome--; saveUI(ui); await syncUI();
  };
  document.getElementById("bgNext").onclick = async ()=>{
    const ui = getUI(); ui.bgIndexHome++; saveUI(ui); await syncUI();
  };
  bgOpacity.oninput = async ()=>{
    const ui = getUI(); ui.bgOpacity = Number(bgOpacity.value);
    saveUI(ui); await applyBackground("home");
  };
  musicToggle.onclick = async ()=>{
    const ui = getUI(); ui.musicOn = !ui.musicOn; saveUI(ui);
    await syncUI();
    if(ui.musicOn){ try{ await audio.play(); }catch{} }
    else{ audio.pause(); audio.currentTime = 0; }
  };

  await syncUI();
  syncKPI();
  window.addEventListener("focus", syncKPI);
</script>
</body>
</html>
