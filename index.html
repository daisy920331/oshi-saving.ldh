<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¿½æ˜Ÿå­˜éŒ¢æ‰‹å¸³</title>
  <link rel="stylesheet" href="assets/app.css" />
  <style>
    .home-main{max-width:980px;margin:0 auto;padding:26px 16px 40px;}
    .home-actions{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      width:100%;
      margin-top:18px;
    }
    @media (min-width:860px){
      .home-actions{grid-template-columns: 1fr 1fr 1fr;}
    }
    .home-actions .btn.primary{
      height:160px;
      padding:22px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      text-decoration:none;
    }
    .home-actions .icon{font-size:40px;}
    .home-actions .desc{font-size:12px;color:var(--muted);}

    /* åº•éƒ¨å°å·¥å…·åˆ— */
    .home-footer{
      margin-top:26px;
      border-top:1px solid var(--line);
      padding-top:12px;
      opacity:.95;
    }
    .mini-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
    .mini-row .btn{padding:8px 12px}
    .mini-row input[type="range"]{width:140px}
    .mini-label{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="bg-wrap"></div>

<header>
  <h1>è¿½æ˜Ÿå­˜éŒ¢æ‰‹å¸³</h1>
  <a class="mini-link" href="settings.html">ç´ æåº«</a>
</header>

<main class="home-main">
  <div class="row" style="justify-content:center;margin-bottom:6px;">
    <span class="pill">æœ¬æœˆå­˜å…¥ï¼š<b id="monthSave">0</b></span>
    <span class="pill">æœ¬æœˆèŠ±è²»ï¼š<b id="monthSpend">0</b></span>
    <span class="pill">é€£çºŒæ‰“å¡ï¼š<b id="streak">0</b> å¤©</span>
  </div>

  <div class="home-actions">
    <a class="btn primary" href="calendar.html">
      <div class="icon">ğŸ“…</div>
      <div>å­˜éŒ¢æœˆæ›†</div>
      <div class="desc">å­˜éŒ¢äº®èµ·ä¾†ï¼‹è²¼ç´™</div>
    </a>

    <a class="btn primary" href="expense.html">
      <div class="icon">ğŸ§¾</div>
      <div>èŠ±è²»</div>
      <div class="desc">èŠ±è²»æœˆæ›†ï¼‹çµ±è¨ˆ</div>
    </a>

    <a class="btn primary" href="events.html">
      <div class="icon">ğŸ“Š</div>
      <div>äº‹ä»¶</div>
      <div class="desc">ä¾äº‹ä»¶å›é¡§æ˜ç´°</div>
    </a>
  </div>

  <div class="home-footer">
    <div class="mini-row">
      <button class="btn" id="bgPrev">èƒŒæ™¯ â—€</button>
      <button class="btn" id="bgNext">èƒŒæ™¯ â–¶</button>

      <span class="mini-label">é€æ˜åº¦</span>
      <input id="bgOpacity" type="range" min="0.1" max="0.6" step="0.05" />

      <span class="mini-label">éŸ³é‡</span>
      <input id="vol" type="range" min="0" max="1" step="0.05" />

      <button class="btn" id="musicToggle">ğŸµ éŸ³æ¨‚</button>
    </div>

    <audio id="bgm" style="width:100%;margin-top:8px;display:none" controls></audio>
  </div>
</main>

<script type="module">
  import {
    getUI, saveUI, applyBackground, setupBGM,
    loadData, monthSum, computeStreak, ymd, pad
  } from "./assets/app.js";

  // èŠ±è²»è³‡æ–™ keyï¼ˆexpense.html ä¹Ÿè¦ç”¨åŒä¸€å€‹ï¼‰
  const EXP_KEY = "oshi_expenses_v1";
  function loadExpenses(){
    const raw = localStorage.getItem(EXP_KEY);
    if(!raw) return { records:{} };
    try{
      const x = JSON.parse(raw);
      return x && x.records ? x : { records:{} };
    }catch{
      return { records:{} };
    }
  }
  function expenseMonthSum(exp, y, m){
    const prefix = `${y}-${pad(m+1)}-`;
    let s = 0;
    for(const k of Object.keys(exp.records)){
      if(!k.startsWith(prefix)) continue;
      const arr = exp.records[k] || [];
      s += arr.reduce((t,r)=>t + (Number(r.amount)||0), 0);
    }
    return s;
  }

  const bgOpacity = document.getElementById("bgOpacity");
  const vol = document.getElementById("vol");
  const musicToggle = document.getElementById("musicToggle");
  const audio = document.getElementById("bgm");

  function syncKPI(){
    const now = new Date();
    const todayKey = ymd(now);

    const saveDataObj = loadData();
    document.getElementById("monthSave").textContent =
      String(monthSum(saveDataObj, now.getFullYear(), now.getMonth(), ""));
    document.getElementById("streak").textContent =
      String(computeStreak(saveDataObj, todayKey, ""));

    const exp = loadExpenses();
    document.getElementById("monthSpend").textContent =
      String(expenseMonthSum(exp, now.getFullYear(), now.getMonth()));
  }

  async function syncUI(){
    const ui = getUI();
    await applyBackground("home");

    bgOpacity.value = String(ui.bgOpacity ?? 0.25);
    vol.value = String(ui.musicVolume ?? 0.6);

    musicToggle.textContent = ui.musicOn ? "ğŸµ éŸ³æ¨‚ ON" : "ğŸµ éŸ³æ¨‚ OFF";
    audio.style.display = ui.musicOn ? "block" : "none";

    await setupBGM(audio);
    audio.volume = Number(vol.value);
  }

  document.getElementById("bgPrev").onclick = async ()=>{
    const ui = getUI(); ui.bgIndexHome = (ui.bgIndexHome ?? 0) - 1;
    saveUI(ui); await syncUI();
  };
  document.getElementById("bgNext").onclick = async ()=>{
    const ui = getUI(); ui.bgIndexHome = (ui.bgIndexHome ?? 0) + 1;
    saveUI(ui); await syncUI();
  };
  bgOpacity.oninput = async ()=>{
    const ui = getUI(); ui.bgOpacity = Number(bgOpacity.value);
    saveUI(ui); await applyBackground("home");
  };
  vol.oninput = ()=>{
    const ui = getUI(); ui.musicVolume = Number(vol.value);
    saveUI(ui);
    audio.volume = Number(vol.value);
  };
  musicToggle.onclick = async ()=>{
    const ui = getUI(); ui.musicOn = !ui.musicOn; saveUI(ui);
    await syncUI();
    if(ui.musicOn){ try{ await audio.play(); }catch{} }
    else{ audio.pause(); audio.currentTime = 0; }
  };

  await syncUI();
  syncKPI();
  window.addEventListener("focus", syncKPI);
</script>
</body>
</html>
