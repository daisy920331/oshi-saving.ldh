<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¿½æ˜Ÿå­˜éŒ¢</title>
  <link rel="stylesheet" href="assets/app.css" />
</head>
<body>
  <div class="bg-wrap"></div>

<header>
  <h1>è¿½æ˜Ÿå­˜éŒ¢æ‰‹å¸³</h1>

  <!-- å³ä¸Šè§’å°å°ç´ æåº« -->
  <a class="mini-link" href="settings.html">ç´ æåº«</a>
</header>

<main class="home-main">
  <!-- KPI -->
  <div class="row">
    <span class="pill">æœ¬æœˆåˆè¨ˆï¼š<b id="monthTotal">0</b></span>
    <span class="pill">é€£çºŒæ‰“å¡ï¼š<b id="streak">0</b> å¤©</span>
  </div>

  <!-- å…©å€‹å¤§å…¥å£ -->
  <div class="home-actions">
    <a class="btn primary" href="calendar.html">
      <div class="icon">ğŸ“…</div>
      <div>æœˆæ›†å­˜éŒ¢</div>
    </a>

    <a class="btn primary" href="events.html">
      <div class="icon">ğŸ“Š</div>
      <div>äº‹ä»¶çµ±æ•´</div>
    </a>
  </div>

  <!-- æœ€ä¸‹é¢ï¼šå¤–è§€èˆ‡éŸ³æ¨‚ -->
  <div class="home-footer">
    <div class="row">
      <button class="btn" id="bgPrev">èƒŒæ™¯ â—€</button>
      <button class="btn" id="bgNext">èƒŒæ™¯ â–¶</button>

      <span>é€æ˜åº¦</span>
      <input id="bgOpacity" type="range" min="0.1" max="0.6" step="0.05" />

      <button class="btn" id="musicToggle">ğŸµ éŸ³æ¨‚</button>
    </div>

    <audio id="bgm" style="width:100%;margin-top:8px;display:none" controls></audio>
  </div>
</main>

<script type="module">
  import {
    getUI, saveUI, applyBackground, setupBGM,
    loadData, monthSum, computeStreak, ymd
  } from "./assets/app.js";

  const bgOpacity = document.getElementById("bgOpacity");
  const musicToggle = document.getElementById("musicToggle");
  const audio = document.getElementById("bgm");

  function syncKPI(){
    const data = loadData();
    const now = new Date();
    const todayKey = ymd(now);
    document.getElementById("monthTotal").textContent =
      monthSum(data, now.getFullYear(), now.getMonth(), "");
    document.getElementById("streak").textContent =
      computeStreak(data, todayKey, "");
  }

  async function syncUI(){
    const ui = getUI();
    await applyBackground("home");
    bgOpacity.value = String(ui.bgOpacity ?? 0.25);
    musicToggle.textContent = ui.musicOn ? "ğŸµ éŸ³æ¨‚ ON" : "ğŸµ éŸ³æ¨‚ OFF";
    audio.style.display = ui.musicOn ? "block" : "none";
    await setupBGM(audio);
  }

  document.getElementById("bgPrev").onclick = async ()=>{
    const ui = getUI(); ui.bgIndexHome--; saveUI(ui); await syncUI();
  };
  document.getElementById("bgNext").onclick = async ()=>{
    const ui = getUI(); ui.bgIndexHome++; saveUI(ui); await syncUI();
  };
  bgOpacity.oninput = async ()=>{
    const ui = getUI(); ui.bgOpacity = Number(bgOpacity.value);
    saveUI(ui); await applyBackground("home");
  };
  musicToggle.onclick = async ()=>{
    const ui = getUI(); ui.musicOn = !ui.musicOn; saveUI(ui);
    await syncUI();
    if(ui.musicOn){ try{ await audio.play(); }catch{} }
    else{ audio.pause(); audio.currentTime = 0; }
  };

  await syncUI();
  syncKPI();
  window.addEventListener("focus", syncKPI);
</script>
</body>
</html>
