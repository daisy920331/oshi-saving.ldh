<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>è¨­å®šï½œLDHè¿½æ˜Ÿå­˜éŒ¢æ‰‹å¸³</title>
  <link rel="stylesheet" href="assets/app.css"/>
  <style>
    .wrap{max-width:920px;margin:0 auto;padding:20px 16px 44px;}
    .paper{
      border:1px solid var(--line);
      border-radius:22px;
      background:rgba(255,255,255,.92);
      box-shadow:0 18px 34px rgba(0,0,0,.10), 0 2px 0 rgba(0,0,0,.03);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .paper::after{
      content:"";
      position:absolute; top:-10px; right:18px;
      width:110px; height:34px;
      background:rgba(180,150,90,.22);
      border:1px solid rgba(180,150,90,.30);
      border-radius:10px;
      transform:rotate(7deg);
      box-shadow:0 10px 18px rgba(0,0,0,.10);
      -webkit-mask-image: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,1) 12%, rgba(0,0,0,1) 88%, rgba(0,0,0,0) 100%);
      mask-image: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,1) 12%, rgba(0,0,0,1) 88%, rgba(0,0,0,0) 100%);
      opacity:.95;
      pointer-events:none;
    }
    h1{margin:0 0 10px;font-size:18px;}
    .hint{color:var(--muted);font-size:12px;margin-top:6px;}
    .card2{border:1px solid var(--line);border-radius:18px;background:#fff;padding:14px;margin-top:12px;}
    .row2{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .catList{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
    .catItem{border:1px solid var(--line);border-radius:16px;background:rgba(250,249,246,.92);padding:12px;}
    .previewTag{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid transparent;
      font-weight:900;font-size:12px;margin-top:10px;width:fit-content;
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}
    .danger{color:#b42318;}
    .mini{font-size:12px;color:var(--muted);}

    /* å€™é¸æ±  UI */
    .poolBox{border:1px dashed rgba(120,120,120,.35); border-radius:16px; padding:12px; background:rgba(250,249,246,.7); margin-top:12px;}
    .tabRow{display:flex; gap:8px; flex-wrap:wrap;}
    .tabBtn{
      padding:8px 12px; border-radius:999px; border:1px solid var(--line);
      background:#fff; font-weight:900; cursor:pointer;
    }
    .tabBtn.on{background:rgba(180,150,90,.16);}
    .poolList{max-height:260px; overflow:auto; margin-top:10px; display:flex; flex-direction:column; gap:6px;}
    .poolItem{
      display:flex; align-items:center; gap:10px;
      border:1px solid rgba(0,0,0,.06);
      background:#fff; border-radius:14px; padding:8px 10px;
    }
    .poolItem small{color:var(--muted);}
    .poolActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center; justify-content:space-between;}
    .modePill{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-weight:900;font-size:12px;}

    /* èƒŒæ™¯åº«åˆ—è¡¨ */
    .bgLibItem{
      display:flex;align-items:center;gap:10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      padding:8px;
    }
    .bgThumb{
      width:44px;height:44px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.08);
      flex:0 0 auto;
    }
  </style>
</head>
<body>
  <div class="bg-wrap"></div>

<header>
  <h1>è¨­å®š</h1>
  <div class="sub"><a href="index.html">â† å›é¦–é </a></div>
</header>

<div class="wrap">
  <div class="paper">

    <div class="card2">
      <h2 style="margin:0 0 10px;font-size:15px;">æ‰‹å¸³åç¨±</h2>
      <label>ä½ çš„åå­—</label>
      <input id="ownerName" type="text" placeholder="ä¾‹ï¼šå°ç¾"/>
      <label style="margin-top:10px;">è‡ªè¨‚æ‰‹å¸³åç¨±ï¼ˆå¯ç•™ç©ºï¼‰</label>
      <input id="siteTitle" type="text" placeholder="ä¾‹ï¼šå°ç¾çš„LDHè¿½æ˜Ÿå­˜éŒ¢æ‰‹å¸³"/>
      <div class="hint">ç•™ç©ºæœƒç”¨ã€Œä½ çš„åå­—ï¼‹çš„LDHè¿½æ˜Ÿå­˜éŒ¢æ‰‹å¸³ã€ã€‚</div>
    </div>

    <div class="card2">
      <h2 style="margin:0 0 10px;font-size:15px;">å°è±¡èˆ‡é¡è‰²</h2>

      <div class="poolBox">
        <b>å¾åå–®åŠ å…¥ï¼ˆå¯å‹¾é¸å¤šå€‹ï¼‰</b>
        <div class="hint">åˆ‡æ›ã€Œåœ˜é«” / å€‹äººã€ï¼Œå†é¸æ“‡é¡¯ç¤ºæ–¹å¼ï¼ˆå®Œæ•´/ç°¡ç¨±ï¼›è‹±æ–‡/æ¼¢å­—ï¼‰ã€‚</div>

        <div class="tabRow" style="margin-top:10px;">
          <button class="tabBtn on" id="tabGroups">åœ˜é«”</button>
          <button class="tabBtn" id="tabPeople">å€‹äºº</button>
        </div>

        <div class="modePill">
          <label class="pill" id="groupModePill">
            åœ˜é«”é¡¯ç¤ºï¼š
            <select id="groupNameMode">
              <option value="full">å®Œæ•´å</option>
              <option value="short">ç°¡ç¨±ï¼ˆè‹¥æœ‰ï¼‰</option>
            </select>
          </label>

          <label class="pill" id="peopleModePill" style="display:none;">
            å€‹äººé¡¯ç¤ºï¼š
            <select id="peopleNameMode">
              <option value="roman">è‹±æ–‡å­—å</option>
              <option value="kanji">æ¼¢å­—åï¼ˆè‹¥æœ‰ï¼‰</option>
            </select>
          </label>
        </div>

        <div class="row2" style="margin-top:10px;">
          <input id="poolSearch" type="text" placeholder="æœå°‹â€¦" style="flex:1 1 240px;">
          <button class="btn" id="poolCheckAll">å…¨é¸</button>
          <button class="btn" id="poolUncheckAll">å…¨ä¸é¸</button>
        </div>

        <div class="poolList" id="poolList"></div>

        <div class="poolActions">
          <small class="danger" id="poolCount">å·²é¸ 0</small>
          <button class="btn" id="poolAddSelected">ï¼‹åŠ å…¥å·²é¸</button>
        </div>
      </div>

      <div class="row2" style="margin-top:12px;">
        <input id="newCat" type="text" placeholder="æ‰‹å‹•æ–°å¢å°è±¡" style="flex:1 1 240px;">
        <button class="btn" id="addCat">ï¼‹æ–°å¢</button>
      </div>

      <div class="catList" id="catList"></div>
      <div class="hint">é¡è‰²æœƒå½±éŸ¿ï¼šæœˆæ›†æ¨™ç±¤ã€äº‹ä»¶é è† å¸¶èˆ‡æ¨™ç±¤ã€‚</div>
    </div>

    <div class="card2">
      <h2 style="margin:0 0 10px;font-size:15px;">èƒŒæ™¯ï¼ˆèƒŒæ™¯åº«ï¼‰</h2>

      <label>é¸æ“‡èƒŒæ™¯ï¼ˆå«ä½ ä¸Šå‚³çš„èƒŒæ™¯åº«ï¼‰</label>
      <select id="bgSelect"></select>

      <label style="margin-top:10px;">ä¸Šå‚³èƒŒæ™¯åˆ°ç´ æåº«ï¼ˆå¯ä¸€æ¬¡é¸å¤šå¼µï¼‰</label>
      <input id="bgUpload" type="file" accept="image/*" multiple />
      <div class="hint">ä¸Šå‚³å¾Œæœƒç•™å­˜åœ¨ä½ çš„èƒŒæ™¯åº«ï¼Œé™¤éä½ è‡ªè¡Œåˆªé™¤æ‰æœƒæ¶ˆå¤±ã€‚</div>

      <div id="bgLibrary" style="margin-top:10px;"></div>
      <div class="hint">æç¤ºï¼šåœ–ç‰‡å¤ªå¤§/å¤ªå¤šå¯èƒ½å¡æ»¿ç€è¦½å™¨å®¹é‡ï¼Œå»ºè­°ç”¨å£“ç¸®å°åœ–ã€‚</div>
    </div>

    <div class="card2">
      <h2 style="margin:0 0 10px;font-size:15px;">éŸ³æ¨‚</h2>
      <label>ä¸Šå‚³éŸ³æ¨‚ï¼ˆmp3 / m4aï¼‰</label>
      <input id="musicUpload" type="file" accept="audio/*"/>
      <div class="hint">éŸ³æ¨‚æœƒå­˜é€²ç€è¦½å™¨ï¼›æ¸…é™¤ç€è¦½è³‡æ–™æœƒæ¶ˆå¤±ï¼Œå¯å†ä¸Šå‚³ã€‚</div>
    </div>

    <div class="btnRow">
      <button class="btn primary" id="save">ğŸ’¾ å„²å­˜è¨­å®š</button>
      <button class="btn" id="reRunSetup">é‡æ–°è·‘é¦–æ¬¡è¨­å®š</button>
      <button class="btn" id="wipeConfig"><span class="danger">æ¸…é™¤è¨­å®š</span></button>
    </div>
    <div class="hint">å„²å­˜å¾Œï¼Œæœˆæ›†/äº‹ä»¶é æœƒå¥—ç”¨æ–°å°è±¡èˆ‡èƒŒæ™¯ã€‚</div>

  </div>
</div>

<script type="module">
  import {
    getConfig, saveConfig, applyBackground, getCatTheme,
    getAllBackgroundOptions, addCustomBackgroundFiles, getCustomBackgrounds, deleteCustomBackground
  } from "./assets/app.js";
  import { PRESET_GROUPS, PRESET_PEOPLE } from "./assets/presets.js";

  await applyBackground("planner");
  const el = (id)=>document.getElementById(id);

  const cfg = getConfig() || {
    setupDone: true,
    ownerName: "",
    siteTitle: "",
    cats: [],
    themeMap: {},
    backgroundUrl: "",
    musicDataUrl: ""
  };

  el("ownerName").value = cfg.ownerName || "";
  el("siteTitle").value = cfg.siteTitle || "";

  // ===== å€™é¸æ±  =====
  let poolMode = "groups"; // groups | people

  function getDisplayNameFromGroup(g){
    const mode = el("groupNameMode").value; // full | short
    if(mode === "short" && g.short) return g.short;
    return g.full;
  }

  function getDisplayNameFromPerson(p){
    const mode = el("peopleNameMode").value; // roman | kanji
    if(mode === "kanji" && p.kanji) return p.kanji;
    return p.roman;
  }

  function poolItems(){
    const q = (el("poolSearch").value || "").trim().toLowerCase();
    let list = [];

    if(poolMode === "groups"){
      list = PRESET_GROUPS.map(g=>({
        text: getDisplayNameFromGroup(g),
        meta: g.short ? `å¯ç”¨ç°¡ç¨±ï¼š${g.short}` : "åœ˜é«”",
      }));
    }else{
      list = PRESET_PEOPLE.map(p=>({
        text: getDisplayNameFromPerson(p),
        meta: p.kanji ? `å¯åˆ‡æ›ï¼š${p.roman} / ${p.kanji}` : "å€‹äºº",
      }));
    }

    if(!q) return list;
    return list.filter(x => (x.text + " " + x.meta).toLowerCase().includes(q));
  }

  function renderPool(){
    const list = poolItems();
    el("poolList").innerHTML = list.map(x=>`
      <label class="poolItem">
        <input type="checkbox" data-text="${escapeHtml(x.text)}">
        <div style="display:flex;flex-direction:column;gap:2px;">
          <b>${escapeHtml(x.text)}</b>
          <small>${escapeHtml(x.meta)}</small>
        </div>
      </label>
    `).join("");

    updatePoolCount();
    el("poolList").querySelectorAll("input[type=checkbox]").forEach(cb=>{
      cb.onchange = updatePoolCount;
    });
  }

  function updatePoolCount(){
    const n = el("poolList").querySelectorAll("input[type=checkbox]:checked").length;
    el("poolCount").textContent = `å·²é¸ ${n}`;
  }

  function setMode(mode){
    poolMode = mode;
    if(mode === "groups"){
      el("tabGroups").classList.add("on");
      el("tabPeople").classList.remove("on");
      el("groupModePill").style.display = "";
      el("peopleModePill").style.display = "none";
    }else{
      el("tabPeople").classList.add("on");
      el("tabGroups").classList.remove("on");
      el("groupModePill").style.display = "none";
      el("peopleModePill").style.display = "";
    }
    el("poolSearch").value = "";
    renderPool();
  }

  el("tabGroups").onclick = ()=>setMode("groups");
  el("tabPeople").onclick = ()=>setMode("people");
  el("poolSearch").oninput = renderPool;
  el("groupNameMode").onchange = renderPool;
  el("peopleNameMode").onchange = renderPool;

  el("poolCheckAll").onclick = ()=>{
    el("poolList").querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked = true);
    updatePoolCount();
  };
  el("poolUncheckAll").onclick = ()=>{
    el("poolList").querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked = false);
    updatePoolCount();
  };

  el("poolAddSelected").onclick = ()=>{
    const picked = Array.from(el("poolList").querySelectorAll("input[type=checkbox]:checked"))
      .map(cb => cb.getAttribute("data-text"))
      .filter(Boolean);

    if(!picked.length) return;

    let added = 0;
    for(const name of picked){
      if(cfg.cats.includes(name)) continue;
      cfg.cats.push(name);
      added += 1;
    }

    renderCats();
    alert(added ? `å·²åŠ å…¥ ${added} å€‹å°è±¡ï¼` : "é¸åˆ°çš„å°è±¡éƒ½å·²ç¶“å­˜åœ¨äº†ï½");
  };

  // ===== å·²é¸åˆ—è¡¨ + é¡è‰² =====
  function renderCats(){
    const list = el("catList");
    list.innerHTML = "";

    cfg.cats.forEach((name, idx)=>{
      const t = cfg.themeMap[name] || getCatTheme(name);

      const div = document.createElement("div");
      div.className = "catItem";
      div.innerHTML = `
        <div class="row2" style="justify-content:space-between;">
          <b>${escapeHtml(name)}</b>
          <button class="btn" data-del="${idx}"><span class="danger">åˆªé™¤</span></button>
        </div>

        <div class="row2" style="margin-top:10px;">
          <div style="flex:1 1 150px;">
            <label>åº•è‰²</label>
            <input type="color" data-k="bg" data-i="${idx}" value="${toHex(t.bg) || "#f1f1f1"}"/>
          </div>
          <div style="flex:1 1 150px;">
            <label>å­—è‰²</label>
            <input type="color" data-k="fg" data-i="${idx}" value="${toHex(t.fg) || "#111111"}"/>
          </div>
          <div style="flex:1 1 150px;">
            <label>é‚Šæ¡†</label>
            <input type="color" data-k="border" data-i="${idx}" value="${toHex(t.border) || "#cccccc"}"/>
          </div>
          <div style="flex:1 1 150px;">
            <label>è† å¸¶</label>
            <input type="color" data-k="tape" data-i="${idx}" value="${toHex(t.tape) || "#cccccc"}"/>
          </div>
        </div>

        <div class="previewTag" style="background:${t.bg};color:${t.fg};border:1px solid ${t.border};">
          é è¦½ï¼š${escapeHtml(name)}
        </div>
      `;
      list.appendChild(div);
    });

    list.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-del"));
        const name = cfg.cats[i];
        if(!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) return;
        cfg.cats.splice(i, 1);
        delete cfg.themeMap[name];
        renderCats();
      };
    });

    list.querySelectorAll("input[type=color]").forEach(inp=>{
      inp.oninput = ()=>{
        const i = Number(inp.getAttribute("data-i"));
        const k = inp.getAttribute("data-k");
        const name = cfg.cats[i];
        if(!cfg.themeMap[name]) cfg.themeMap[name] = { bg:"", fg:"", border:"", tape:"" };
        cfg.themeMap[name][k] = inp.value;
        renderCats();
      };
    });
  }

  el("addCat").onclick = ()=>{
    const v = (el("newCat").value || "").trim();
    if(!v) return;
    if(cfg.cats.includes(v)){
      alert("é€™å€‹å°è±¡å·²å­˜åœ¨ï¼");
      return;
    }
    cfg.cats.push(v);
    el("newCat").value = "";
    renderCats();
  };

  // ===== èƒŒæ™¯åº« =====
  function renderBgSelect(){
    const opts = getAllBackgroundOptions();
    el("bgSelect").innerHTML = opts.map(o => {
      const v = escapeHtml(o.value);
      return `<option value="${v}">${escapeHtml(o.label)}</option>`;
    }).join("");

    if(cfg.backgroundUrl){
      el("bgSelect").value = cfg.backgroundUrl;
    }else{
      el("bgSelect").value = (opts[0]?.value) || "";
    }
  }

  function renderBgLibrary(){
    const list = getCustomBackgrounds();
    const box = el("bgLibrary");

    if(!list.length){
      box.innerHTML = `<div class="hint">ï¼ˆèƒŒæ™¯åº«ç›®å‰é‚„æ²’æœ‰åœ–ç‰‡ï¼‰</div>`;
      return;
    }

    box.innerHTML = `
      <div class="hint">èƒŒæ™¯åº«ï¼ˆé»åˆªé™¤æ‰æœƒç§»é™¤ï¼‰ï¼š</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
        ${list.map(item => `
          <div class="bgLibItem">
            <img class="bgThumb" src="${item.dataUrl}" alt="">
            <div style="flex:1;min-width:0;">
              <b style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(item.name)}</b>
              <small class="mini">å·²ä¸Šå‚³</small>
            </div>
            <button class="btn" data-delbg="${item.id}"><span class="danger">åˆªé™¤</span></button>
          </div>
        `).join("")}
      </div>
    `;

    box.querySelectorAll("[data-delbg]").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.getAttribute("data-delbg");
        if(!confirm("ç¢ºå®šå¾èƒŒæ™¯åº«åˆªé™¤é€™å¼µèƒŒæ™¯ï¼Ÿ")) return;

        // è‹¥æ­£åœ¨ä½¿ç”¨é€™å¼µèƒŒæ™¯ï¼Œåˆªé™¤å¾Œå›åˆ°ç¬¬ä¸€å€‹å¯ç”¨èƒŒæ™¯
        const before = getCustomBackgrounds();
        const deleting = before.find(x=>x.id===id);

        deleteCustomBackground(id);

        if(deleting && cfg.backgroundUrl === deleting.dataUrl){
          cfg.backgroundUrl = "";
          saveConfig(cfg);
        }

        renderBgSelect();
        renderBgLibrary();
        await applyBackground("planner");
      };
    });
  }

  // init èƒŒæ™¯
  renderBgSelect();
  renderBgLibrary();

  el("bgSelect").onchange = async ()=>{
    cfg.backgroundUrl = el("bgSelect").value;
    saveConfig(cfg);
    await applyBackground("planner");
  };

  el("bgUpload").onchange = async (e)=>{
    const files = e.target.files;
    if(!files || !files.length) return;

    await addCustomBackgroundFiles(files);

    const latest = getCustomBackgrounds().slice(-1)[0];
    if(latest){
      cfg.backgroundUrl = latest.dataUrl;
      saveConfig(cfg);
    }

    e.target.value = "";
    renderBgSelect();
    renderBgLibrary();
    await applyBackground("planner");
    alert("å·²åŠ å…¥èƒŒæ™¯åº«ï¼å¯ä»¥åœ¨ä¸‹æ‹‰é¸å–®åˆ‡æ›ã€‚");
  };

  // éŸ³æ¨‚
  el("musicUpload").onchange = async (e)=>{
    const f = (e.target.files || [])[0];
    if(!f) return;

    const dataUrl = await new Promise(res=>{
      const r = new FileReader();
      r.onload = ()=>res(String(r.result));
      r.readAsDataURL(f);
    });

    cfg.musicDataUrl = dataUrl;
    alert("å·²ä¸Šå‚³éŸ³æ¨‚ï¼è¨˜å¾—æŒ‰ã€å„²å­˜è¨­å®šã€");
  };

  // å„²å­˜
  el("save").onclick = ()=>{
    cfg.ownerName = (el("ownerName").value || "").trim();
    cfg.siteTitle = (el("siteTitle").value || "").trim();
    cfg.setupDone = true;
    saveConfig(cfg);
    alert("å·²å„²å­˜ï¼");
  };

  el("reRunSetup").onclick = ()=>{
    location.href = "setup.html";
  };

  el("wipeConfig").onclick = ()=>{
    if(!confirm("ç¢ºå®šæ¸…é™¤è¨­å®šï¼Ÿæ¸…é™¤å¾Œä¸‹æ¬¡æœƒé‡æ–°è·‘é¦–æ¬¡è¨­å®šã€‚")) return;
    localStorage.removeItem("oshi_config_v1");
    alert("å·²æ¸…é™¤ã€‚å°‡è·³å›é¦–æ¬¡è¨­å®šã€‚");
    location.href = "setup.html";
  };

  function toHex(x){
    if(!x) return "";
    const s = String(x).trim();
    if(s.startsWith("#")) return s.length===4 ? expand3(s) : s;
    return "";
  }
  function expand3(h){ return "#" + h[1]+h[1]+h[2]+h[2]+h[3]+h[3]; }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // init
  setMode("groups");
  renderCats();
</script>
</body>
</html>
