<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>追星存錢｜素材管理</title>
  <link rel="stylesheet" href="assets/app.css" />
</head>
<body>
  <div class="bg-wrap"></div>

  <header>
    <h1>素材管理（不用改程式碼）</h1>
    <p class="sub">
      <a href="index.html">← 回首頁</a>　｜　
      這頁用 GitHub API 讀取你的 repo 內容：丟圖/音樂 → commit → 回來按刷新就會更新。
    </p>
  </header>

  <main class="grid">
    <section class="card">
      <h2 style="margin:0 0 8px; font-size:15px;">連結你的 GitHub Repo（填一次就好）</h2>

      <label>GitHub 使用者名稱（username）</label>
      <input id="owner" placeholder="例如：yourname" />

      <label>Repo 名稱（repository）</label>
      <input id="repo" placeholder="例如：oshi-saving" />

      <label>分支（branch）</label>
      <input id="branch" placeholder="通常是 main" value="main" />

      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="saveRepo">💾 儲存設定</button>
        <button class="btn" id="refreshLists">🔄 重新抓取清單</button>
      </div>

      <p class="hint">
        請把檔案放在這些資料夾：<br>
        - 鼓勵圖：<b>assets/images/reward/</b><br>
        - 首頁背景：<b>assets/images/home/</b><br>
        - 手帳背景：<b>assets/images/planner/</b><br>
        - 音樂：<b>assets/music/</b>
      </p>
      <p class="hint">
        注意：repo 必須是 <b>Public</b>，GitHub API 才能讀取。
      </p>
    </section>

    <aside class="card">
      <h2 style="margin:0 0 8px; font-size:15px;">目前抓到的素材</h2>

      <div class="row" style="margin-top:10px;">
        <span class="pill">鼓勵圖：<b id="nReward">0</b></span>
        <span class="pill">首頁背景：<b id="nHome">0</b></span>
        <span class="pill">手帳背景：<b id="nPlanner">0</b></span>
        <span class="pill">音樂：<b id="nMusic">0</b></span>
      </div>

      <label style="margin-top:14px;">鼓勵圖預覽（前 12 張）</label>
      <div class="row" id="rewardPreview"></div>

      <label style="margin-top:14px;">背景預覽（首頁/手帳各前 6 張）</label>
      <div class="row" id="bgPreview"></div>

      <label style="margin-top:14px;">音樂清單</label>
      <div id="musicPreview" class="hint"></div>

      <div class="row" style="margin-top:14px;">
        <a class="btn" href="calendar.html">去月曆頁測試</a>
        <a class="btn" href="events.html">去事件頁測試</a>
      </div>

      <p class="hint">
        如果顯示 0：通常是 repo 私有、路徑不對、或檔案還沒 commit。
      </p>
    </aside>
  </main>

  <script type="module">
    import {
      applyBackground,
      setRepoConfig, getRepoConfig,
      refreshRemoteAssetLists, getAssetLists
    } from "./assets/app.js";

    await applyBackground("planner");

    const $ = (id)=>document.getElementById(id);

    function renderPreviews(lists){
      $("nReward").textContent = lists.reward.length;
      $("nHome").textContent = lists.home.length;
      $("nPlanner").textContent = lists.planner.length;
      $("nMusic").textContent = lists.music.length;

      const rewardBox = $("rewardPreview");
      rewardBox.innerHTML = "";
      lists.reward.slice(0,12).forEach(url=>{
        const img = document.createElement("img");
        img.src = url;
        img.className = "thumb";
        img.alt = "reward";
        rewardBox.appendChild(img);
      });

      const bgBox = $("bgPreview");
      bgBox.innerHTML = "";
      lists.home.slice(0,6).forEach(url=>{
        const img = document.createElement("img");
        img.src = url;
        img.className = "thumb";
        img.alt = "home";
        bgBox.appendChild(img);
      });
      lists.planner.slice(0,6).forEach(url=>{
        const img = document.createElement("img");
        img.src = url;
        img.className = "thumb";
        img.alt = "planner";
        bgBox.appendChild(img);
      });

      const musicBox = $("musicPreview");
      if(lists.music.length === 0){
        musicBox.textContent = "尚未抓到音樂檔（assets/music/）";
      }else{
        musicBox.innerHTML = lists.music.map(u=>`• ${u.split("/").pop()}`).join("<br>");
      }
    }

    function syncInputs(){
      const cfg = getRepoConfig();
      $("owner").value = cfg.owner || "";
      $("repo").value = cfg.repo || "";
      $("branch").value = cfg.branch || "main";
    }

    async function refresh(){
      const cfg = getRepoConfig();
      if(!cfg.owner || !cfg.repo){
        renderPreviews({reward:[], home:[], planner:[], music:[]});
        return;
      }
      await refreshRemoteAssetLists();
      const lists = await getAssetLists();
      renderPreviews(lists);
    }

    $("saveRepo").addEventListener("click", async ()=>{
      const owner = $("owner").value.trim();
      const repo = $("repo").value.trim();
      const branch = $("branch").value.trim() || "main";
      setRepoConfig({owner, repo, branch});
      alert("已儲存 Repo 設定！接著按「重新抓取清單」。");
    });

    $("refreshLists").addEventListener("click", async ()=>{
      try{
        await refresh();
        alert("已更新素材清單！");
      }catch(e){
        console.error(e);
        alert("抓取失敗：請確認 repo 是 Public、路徑正確、且檔案已 commit。");
      }
    });

    syncInputs();
    await refresh();
  </script>
</body>
</html>
